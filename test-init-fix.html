<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始化修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .countdown-display {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 15px 0;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #007bff;
        }
        .interval-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .status-display {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            font-family: monospace;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .fix-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>🔧 初始化修复测试</h1>
    
    <div class="fix-info">
        <h2>修复内容</h2>
        <ul>
            <li>在应用初始化时添加了<code>forceUISync</code>方法</li>
            <li>强制同步HTML显示值与实际设置值</li>
            <li>添加了详细的调试日志</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>1. 模拟初始化过程</h2>
        <button class="btn btn-primary" onclick="simulateInit()">模拟初始化</button>
        <div id="init-results"></div>
    </div>

    <div class="test-section">
        <h2>2. 测试倒计时逻辑</h2>
        <div>
            <label><strong>水提醒间隔:</strong> 
                <input type="number" id="water-interval-display" min="1" max="60" value="30" class="interval-input"> 分钟
            </label>
            <button class="btn btn-success" onclick="testWaterReminder()">测试水提醒</button>
        </div>
        
        <div>
            <label><strong>站立提醒间隔:</strong> 
                <input type="number" id="standup-interval-display" min="1" max="60" value="30" class="interval-input"> 分钟
            </label>
            <button class="btn btn-success" onclick="testStandupReminder()">测试站立提醒</button>
        </div>
        
        <button class="btn btn-danger" onclick="stopAllTests()">停止所有测试</button>
        
        <div class="countdown-display" id="test-countdown">--:--</div>
        
        <div class="status-display" id="test-status">
            状态: 未开始测试
        </div>
        
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>3. 验证修复效果</h2>
        <button class="btn btn-primary" onclick="verifyFix()">验证修复效果</button>
        <div id="verify-results"></div>
    </div>

    <div class="test-section">
        <h2>4. 调试日志</h2>
        <button class="btn btn-primary" onclick="clearLog()">清除日志</button>
        <pre id="debug-log"></pre>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/notification-service.js"></script>
    <script src="js/reminder-manager.js"></script>
    <script src="js/water-reminder.js"></script>

    <script>
        let testReminder = null;
        let updateTimer = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        function simulateInit() {
            log('开始模拟初始化过程...');
            
            try {
                let results = '<div class="result info"><h3>初始化过程模拟</h3>';
                
                // 步骤1: 检查HTML初始值
                const waterDisplay = document.getElementById('water-interval-display');
                const standupDisplay = document.getElementById('standup-interval-display');
                
                results += `<p><strong>步骤1 - HTML初始值:</strong></p>`;
                results += `<p>水提醒: ${waterDisplay.value} 分钟</p>`;
                results += `<p>站立提醒: ${standupDisplay.value} 分钟</p>`;
                
                log(`HTML初始值 - 水提醒: ${waterDisplay.value}, 站立提醒: ${standupDisplay.value}`);
                
                // 步骤2: 加载设置
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const settings = appSettings.getSettings();
                
                results += `<p><strong>步骤2 - 加载的设置:</strong></p>`;
                results += `<p>水提醒: ${settings.water.interval} 分钟</p>`;
                results += `<p>站立提醒: ${settings.standup.interval} 分钟</p>`;
                
                log(`加载的设置 - 水提醒: ${settings.water.interval}, 站立提醒: ${settings.standup.interval}`);
                
                // 步骤3: 模拟forceUISync
                results += `<p><strong>步骤3 - 强制UI同步:</strong></p>`;
                
                const oldWaterValue = waterDisplay.value;
                const oldStandupValue = standupDisplay.value;
                
                waterDisplay.value = settings.water.interval || 30;
                standupDisplay.value = settings.standup.interval || 30;
                
                results += `<p>水提醒: ${oldWaterValue} → ${waterDisplay.value}</p>`;
                results += `<p>站立提醒: ${oldStandupValue} → ${standupDisplay.value}</p>`;
                
                log(`强制同步 - 水提醒: ${oldWaterValue} → ${waterDisplay.value}`);
                log(`强制同步 - 站立提醒: ${oldStandupValue} → ${standupDisplay.value}`);
                
                // 步骤4: 验证同步结果
                if (waterDisplay.value == settings.water.interval && standupDisplay.value == settings.standup.interval) {
                    results += '<div class="result success">✅ UI同步成功，HTML显示值与设置一致</div>';
                    log('UI同步成功', 'success');
                } else {
                    results += '<div class="result error">❌ UI同步失败，仍存在不一致</div>';
                    log('UI同步失败', 'error');
                }
                
                results += '</div>';
                
                document.getElementById('init-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">模拟初始化失败: ${error.message}</div>`;
                document.getElementById('init-results').innerHTML = result;
                log(`模拟初始化失败: ${error.message}`, 'error');
            }
        }

        function testWaterReminder() {
            testReminder('water');
        }

        function testStandupReminder() {
            testReminder('standup');
        }

        function testReminder(type) {
            try {
                const displayElement = document.getElementById(`${type}-interval-display`);
                const interval = parseInt(displayElement.value);
                
                log(`开始测试${type}提醒 - 间隔: ${interval}分钟`);
                
                // 停止之前的测试
                if (testReminder) {
                    testReminder.stop();
                }
                if (updateTimer) {
                    clearInterval(updateTimer);
                }
                
                // 创建通知服务
                const notificationService = {
                    showNotification: (type, title, message) => {
                        log(`通知触发: ${title} - ${message}`);
                        document.getElementById('test-status').textContent = `提醒触发: ${title}`;
                        
                        // 验证时间准确性
                        const elapsedTime = Date.now() - testStartTime;
                        const elapsedMinutes = Math.floor(elapsedTime / 60000);
                        const expectedMinutes = interval;
                        
                        if (Math.abs(elapsedMinutes - expectedMinutes) <= 1) {
                            const result = `<div class="result success">✅ 提醒时间准确: 预期${expectedMinutes}分钟，实际${elapsedMinutes}分钟</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`提醒时间准确: 预期${expectedMinutes}分钟，实际${elapsedMinutes}分钟`, 'success');
                        } else {
                            const result = `<div class="result error">❌ 提醒时间不准确: 预期${expectedMinutes}分钟，实际${elapsedMinutes}分钟</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`提醒时间不准确: 预期${expectedMinutes}分钟，实际${elapsedMinutes}分钟`, 'error');
                        }
                    },
                    showInPageAlert: (type, options) => {
                        log(`页面提醒: ${options.title} - ${options.message}`);
                    }
                };

                // 创建提醒设置
                const reminderSettings = {
                    enabled: true,
                    interval: interval,
                    sound: true,
                    lastReminder: null,
                    target: 8
                };

                // 创建提醒实例
                testReminder = new WaterReminder(reminderSettings, notificationService);
                testStartTime = Date.now();

                // 设置状态变化回调
                testReminder.setStatusChangeCallback((status) => {
                    log(`状态变化: ${status.status}, 剩余时间: ${Math.floor(status.timeRemaining/1000)}秒`);
                    
                    if (status.status === 'started') {
                        const actualMinutes = Math.floor(status.timeRemaining / 60000);
                        const actualSeconds = Math.floor((status.timeRemaining % 60000) / 1000);
                        
                        document.getElementById('test-status').textContent = 
                            `测试中 - 剩余: ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`;
                        
                        // 检查初始倒计时是否正确
                        if (actualMinutes === interval && actualSeconds === 0) {
                            const result = `<div class="result success">✅ 初始倒计时正确: ${actualMinutes}:00</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`初始倒计时正确: ${actualMinutes}:00`, 'success');
                        } else {
                            const result = `<div class="result error">❌ 初始倒计时错误: 预期 ${interval}:00, 实际 ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`初始倒计时错误: 预期 ${interval}:00, 实际 ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`, 'error');
                        }
                    }
                });

                // 设置时间更新回调
                testReminder.setTimeUpdateCallback((timeInfo) => {
                    updateCountdown(timeInfo.timeRemaining);
                });

                // 启动提醒
                testReminder.start();

                // 启动UI更新定时器
                updateTimer = setInterval(() => {
                    if (testReminder && testReminder.isActive) {
                        const status = testReminder.getCurrentStatus();
                        updateCountdown(status.timeRemaining);
                    }
                }, 1000);

                log(`${type}提醒测试已启动`);

            } catch (error) {
                log(`测试${type}提醒失败: ${error.message}`, 'error');
                document.getElementById('test-status').textContent = `测试失败: ${error.message}`;
            }
        }

        function stopAllTests() {
            try {
                if (testReminder) {
                    testReminder.stop();
                    testReminder = null;
                }
                
                if (updateTimer) {
                    clearInterval(updateTimer);
                    updateTimer = null;
                }

                updateCountdown(0);
                document.getElementById('test-status').textContent = '所有测试已停止';
                log('所有测试已停止');

            } catch (error) {
                log(`停止测试失败: ${error.message}`, 'error');
            }
        }

        function updateCountdown(timeRemaining) {
            const countdownElement = document.getElementById('test-countdown');
            
            if (timeRemaining <= 0) {
                countdownElement.textContent = '--:--';
                countdownElement.style.color = '#6c757d';
            } else {
                const minutes = Math.floor(timeRemaining / 60000);
                const seconds = Math.floor((timeRemaining % 60000) / 1000);
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining < 60000) {
                    countdownElement.style.color = '#dc3545';
                } else if (timeRemaining < 300000) {
                    countdownElement.style.color = '#fd7e14';
                } else {
                    countdownElement.style.color = '#007bff';
                }
            }
        }

        function verifyFix() {
            log('开始验证修复效果...');
            
            try {
                let results = '<div class="result info"><h3>修复效果验证</h3>';
                
                // 检查当前HTML值
                const waterDisplay = document.getElementById('water-interval-display');
                const standupDisplay = document.getElementById('standup-interval-display');
                
                // 检查设置值
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const settings = appSettings.getSettings();
                
                results += '<p><strong>当前状态:</strong></p>';
                results += `<p>HTML水提醒显示: ${waterDisplay.value} 分钟</p>`;
                results += `<p>设置水提醒间隔: ${settings.water.interval} 分钟</p>`;
                results += `<p>HTML站立提醒显示: ${standupDisplay.value} 分钟</p>`;
                results += `<p>设置站立提醒间隔: ${settings.standup.interval} 分钟</p>`;
                
                // 验证一致性
                const waterConsistent = waterDisplay.value == settings.water.interval;
                const standupConsistent = standupDisplay.value == settings.standup.interval;
                
                if (waterConsistent && standupConsistent) {
                    results += '<div class="result success">✅ 修复成功！HTML显示值与设置完全一致</div>';
                    results += '<div class="result info">💡 现在首次点击START应该显示正确的倒计时</div>';
                    log('修复验证成功：HTML显示值与设置一致', 'success');
                } else {
                    results += '<div class="result error">❌ 修复未完全生效，仍存在不一致</div>';
                    if (!waterConsistent) {
                        results += `<div class="result warning">水提醒不一致: HTML=${waterDisplay.value}, 设置=${settings.water.interval}</div>`;
                    }
                    if (!standupConsistent) {
                        results += `<div class="result warning">站立提醒不一致: HTML=${standupDisplay.value}, 设置=${settings.standup.interval}</div>`;
                    }
                    log('修复验证失败：仍存在不一致', 'error');
                }
                
                results += '</div>';
                
                document.getElementById('verify-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">验证修复效果失败: ${error.message}</div>`;
                document.getElementById('verify-results').innerHTML = result;
                log(`验证修复效果失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('初始化修复测试页面已加载');
            log('请按顺序执行：1.模拟初始化 → 2.测试倒计时 → 3.验证修复效果');
        });
    </script>
</body>
</html>