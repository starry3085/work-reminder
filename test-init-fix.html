<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå§‹åŒ–ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .countdown-display {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 15px 0;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #007bff;
        }
        .interval-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .status-display {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            font-family: monospace;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .fix-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ åˆå§‹åŒ–ä¿®å¤æµ‹è¯•</h1>
    
    <div class="fix-info">
        <h2>ä¿®å¤å†…å®¹</h2>
        <ul>
            <li>åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶æ·»åŠ äº†<code>forceUISync</code>æ–¹æ³•</li>
            <li>å¼ºåˆ¶åŒæ­¥HTMLæ˜¾ç¤ºå€¼ä¸å®é™…è®¾ç½®å€¼</li>
            <li>æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>1. æ¨¡æ‹Ÿåˆå§‹åŒ–è¿‡ç¨‹</h2>
        <button class="btn btn-primary" onclick="simulateInit()">æ¨¡æ‹Ÿåˆå§‹åŒ–</button>
        <div id="init-results"></div>
    </div>

    <div class="test-section">
        <h2>2. æµ‹è¯•å€’è®¡æ—¶é€»è¾‘</h2>
        <div>
            <label><strong>æ°´æé†’é—´éš”:</strong> 
                <input type="number" id="water-interval-display" min="1" max="60" value="30" class="interval-input"> åˆ†é’Ÿ
            </label>
            <button class="btn btn-success" onclick="testWaterReminder()">æµ‹è¯•æ°´æé†’</button>
        </div>
        
        <div>
            <label><strong>ç«™ç«‹æé†’é—´éš”:</strong> 
                <input type="number" id="standup-interval-display" min="1" max="60" value="30" class="interval-input"> åˆ†é’Ÿ
            </label>
            <button class="btn btn-success" onclick="testStandupReminder()">æµ‹è¯•ç«™ç«‹æé†’</button>
        </div>
        
        <button class="btn btn-danger" onclick="stopAllTests()">åœæ­¢æ‰€æœ‰æµ‹è¯•</button>
        
        <div class="countdown-display" id="test-countdown">--:--</div>
        
        <div class="status-display" id="test-status">
            çŠ¶æ€: æœªå¼€å§‹æµ‹è¯•
        </div>
        
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>3. éªŒè¯ä¿®å¤æ•ˆæœ</h2>
        <button class="btn btn-primary" onclick="verifyFix()">éªŒè¯ä¿®å¤æ•ˆæœ</button>
        <div id="verify-results"></div>
    </div>

    <div class="test-section">
        <h2>4. è°ƒè¯•æ—¥å¿—</h2>
        <button class="btn btn-primary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <pre id="debug-log"></pre>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/notification-service.js"></script>
    <script src="js/reminder-manager.js"></script>
    <script src="js/water-reminder.js"></script>

    <script>
        let testReminder = null;
        let updateTimer = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        function simulateInit() {
            log('å¼€å§‹æ¨¡æ‹Ÿåˆå§‹åŒ–è¿‡ç¨‹...');
            
            try {
                let results = '<div class="result info"><h3>åˆå§‹åŒ–è¿‡ç¨‹æ¨¡æ‹Ÿ</h3>';
                
                // æ­¥éª¤1: æ£€æŸ¥HTMLåˆå§‹å€¼
                const waterDisplay = document.getElementById('water-interval-display');
                const standupDisplay = document.getElementById('standup-interval-display');
                
                results += `<p><strong>æ­¥éª¤1 - HTMLåˆå§‹å€¼:</strong></p>`;
                results += `<p>æ°´æé†’: ${waterDisplay.value} åˆ†é’Ÿ</p>`;
                results += `<p>ç«™ç«‹æé†’: ${standupDisplay.value} åˆ†é’Ÿ</p>`;
                
                log(`HTMLåˆå§‹å€¼ - æ°´æé†’: ${waterDisplay.value}, ç«™ç«‹æé†’: ${standupDisplay.value}`);
                
                // æ­¥éª¤2: åŠ è½½è®¾ç½®
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const settings = appSettings.getSettings();
                
                results += `<p><strong>æ­¥éª¤2 - åŠ è½½çš„è®¾ç½®:</strong></p>`;
                results += `<p>æ°´æé†’: ${settings.water.interval} åˆ†é’Ÿ</p>`;
                results += `<p>ç«™ç«‹æé†’: ${settings.standup.interval} åˆ†é’Ÿ</p>`;
                
                log(`åŠ è½½çš„è®¾ç½® - æ°´æé†’: ${settings.water.interval}, ç«™ç«‹æé†’: ${settings.standup.interval}`);
                
                // æ­¥éª¤3: æ¨¡æ‹ŸforceUISync
                results += `<p><strong>æ­¥éª¤3 - å¼ºåˆ¶UIåŒæ­¥:</strong></p>`;
                
                const oldWaterValue = waterDisplay.value;
                const oldStandupValue = standupDisplay.value;
                
                waterDisplay.value = settings.water.interval || 30;
                standupDisplay.value = settings.standup.interval || 30;
                
                results += `<p>æ°´æé†’: ${oldWaterValue} â†’ ${waterDisplay.value}</p>`;
                results += `<p>ç«™ç«‹æé†’: ${oldStandupValue} â†’ ${standupDisplay.value}</p>`;
                
                log(`å¼ºåˆ¶åŒæ­¥ - æ°´æé†’: ${oldWaterValue} â†’ ${waterDisplay.value}`);
                log(`å¼ºåˆ¶åŒæ­¥ - ç«™ç«‹æé†’: ${oldStandupValue} â†’ ${standupDisplay.value}`);
                
                // æ­¥éª¤4: éªŒè¯åŒæ­¥ç»“æœ
                if (waterDisplay.value == settings.water.interval && standupDisplay.value == settings.standup.interval) {
                    results += '<div class="result success">âœ… UIåŒæ­¥æˆåŠŸï¼ŒHTMLæ˜¾ç¤ºå€¼ä¸è®¾ç½®ä¸€è‡´</div>';
                    log('UIåŒæ­¥æˆåŠŸ', 'success');
                } else {
                    results += '<div class="result error">âŒ UIåŒæ­¥å¤±è´¥ï¼Œä»å­˜åœ¨ä¸ä¸€è‡´</div>';
                    log('UIåŒæ­¥å¤±è´¥', 'error');
                }
                
                results += '</div>';
                
                document.getElementById('init-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">æ¨¡æ‹Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                document.getElementById('init-results').innerHTML = result;
                log(`æ¨¡æ‹Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testWaterReminder() {
            testReminder('water');
        }

        function testStandupReminder() {
            testReminder('standup');
        }

        function testReminder(type) {
            try {
                const displayElement = document.getElementById(`${type}-interval-display`);
                const interval = parseInt(displayElement.value);
                
                log(`å¼€å§‹æµ‹è¯•${type}æé†’ - é—´éš”: ${interval}åˆ†é’Ÿ`);
                
                // åœæ­¢ä¹‹å‰çš„æµ‹è¯•
                if (testReminder) {
                    testReminder.stop();
                }
                if (updateTimer) {
                    clearInterval(updateTimer);
                }
                
                // åˆ›å»ºé€šçŸ¥æœåŠ¡
                const notificationService = {
                    showNotification: (type, title, message) => {
                        log(`é€šçŸ¥è§¦å‘: ${title} - ${message}`);
                        document.getElementById('test-status').textContent = `æé†’è§¦å‘: ${title}`;
                        
                        // éªŒè¯æ—¶é—´å‡†ç¡®æ€§
                        const elapsedTime = Date.now() - testStartTime;
                        const elapsedMinutes = Math.floor(elapsedTime / 60000);
                        const expectedMinutes = interval;
                        
                        if (Math.abs(elapsedMinutes - expectedMinutes) <= 1) {
                            const result = `<div class="result success">âœ… æé†’æ—¶é—´å‡†ç¡®: é¢„æœŸ${expectedMinutes}åˆ†é’Ÿï¼Œå®é™…${elapsedMinutes}åˆ†é’Ÿ</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`æé†’æ—¶é—´å‡†ç¡®: é¢„æœŸ${expectedMinutes}åˆ†é’Ÿï¼Œå®é™…${elapsedMinutes}åˆ†é’Ÿ`, 'success');
                        } else {
                            const result = `<div class="result error">âŒ æé†’æ—¶é—´ä¸å‡†ç¡®: é¢„æœŸ${expectedMinutes}åˆ†é’Ÿï¼Œå®é™…${elapsedMinutes}åˆ†é’Ÿ</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`æé†’æ—¶é—´ä¸å‡†ç¡®: é¢„æœŸ${expectedMinutes}åˆ†é’Ÿï¼Œå®é™…${elapsedMinutes}åˆ†é’Ÿ`, 'error');
                        }
                    },
                    showInPageAlert: (type, options) => {
                        log(`é¡µé¢æé†’: ${options.title} - ${options.message}`);
                    }
                };

                // åˆ›å»ºæé†’è®¾ç½®
                const reminderSettings = {
                    enabled: true,
                    interval: interval,
                    sound: true,
                    lastReminder: null,
                    target: 8
                };

                // åˆ›å»ºæé†’å®ä¾‹
                testReminder = new WaterReminder(reminderSettings, notificationService);
                testStartTime = Date.now();

                // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
                testReminder.setStatusChangeCallback((status) => {
                    log(`çŠ¶æ€å˜åŒ–: ${status.status}, å‰©ä½™æ—¶é—´: ${Math.floor(status.timeRemaining/1000)}ç§’`);
                    
                    if (status.status === 'started') {
                        const actualMinutes = Math.floor(status.timeRemaining / 60000);
                        const actualSeconds = Math.floor((status.timeRemaining % 60000) / 1000);
                        
                        document.getElementById('test-status').textContent = 
                            `æµ‹è¯•ä¸­ - å‰©ä½™: ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`;
                        
                        // æ£€æŸ¥åˆå§‹å€’è®¡æ—¶æ˜¯å¦æ­£ç¡®
                        if (actualMinutes === interval && actualSeconds === 0) {
                            const result = `<div class="result success">âœ… åˆå§‹å€’è®¡æ—¶æ­£ç¡®: ${actualMinutes}:00</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`åˆå§‹å€’è®¡æ—¶æ­£ç¡®: ${actualMinutes}:00`, 'success');
                        } else {
                            const result = `<div class="result error">âŒ åˆå§‹å€’è®¡æ—¶é”™è¯¯: é¢„æœŸ ${interval}:00, å®é™… ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}</div>`;
                            document.getElementById('test-results').innerHTML = result;
                            log(`åˆå§‹å€’è®¡æ—¶é”™è¯¯: é¢„æœŸ ${interval}:00, å®é™… ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`, 'error');
                        }
                    }
                });

                // è®¾ç½®æ—¶é—´æ›´æ–°å›è°ƒ
                testReminder.setTimeUpdateCallback((timeInfo) => {
                    updateCountdown(timeInfo.timeRemaining);
                });

                // å¯åŠ¨æé†’
                testReminder.start();

                // å¯åŠ¨UIæ›´æ–°å®šæ—¶å™¨
                updateTimer = setInterval(() => {
                    if (testReminder && testReminder.isActive) {
                        const status = testReminder.getCurrentStatus();
                        updateCountdown(status.timeRemaining);
                    }
                }, 1000);

                log(`${type}æé†’æµ‹è¯•å·²å¯åŠ¨`);

            } catch (error) {
                log(`æµ‹è¯•${type}æé†’å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('test-status').textContent = `æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        function stopAllTests() {
            try {
                if (testReminder) {
                    testReminder.stop();
                    testReminder = null;
                }
                
                if (updateTimer) {
                    clearInterval(updateTimer);
                    updateTimer = null;
                }

                updateCountdown(0);
                document.getElementById('test-status').textContent = 'æ‰€æœ‰æµ‹è¯•å·²åœæ­¢';
                log('æ‰€æœ‰æµ‹è¯•å·²åœæ­¢');

            } catch (error) {
                log(`åœæ­¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateCountdown(timeRemaining) {
            const countdownElement = document.getElementById('test-countdown');
            
            if (timeRemaining <= 0) {
                countdownElement.textContent = '--:--';
                countdownElement.style.color = '#6c757d';
            } else {
                const minutes = Math.floor(timeRemaining / 60000);
                const seconds = Math.floor((timeRemaining % 60000) / 1000);
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining < 60000) {
                    countdownElement.style.color = '#dc3545';
                } else if (timeRemaining < 300000) {
                    countdownElement.style.color = '#fd7e14';
                } else {
                    countdownElement.style.color = '#007bff';
                }
            }
        }

        function verifyFix() {
            log('å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...');
            
            try {
                let results = '<div class="result info"><h3>ä¿®å¤æ•ˆæœéªŒè¯</h3>';
                
                // æ£€æŸ¥å½“å‰HTMLå€¼
                const waterDisplay = document.getElementById('water-interval-display');
                const standupDisplay = document.getElementById('standup-interval-display');
                
                // æ£€æŸ¥è®¾ç½®å€¼
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const settings = appSettings.getSettings();
                
                results += '<p><strong>å½“å‰çŠ¶æ€:</strong></p>';
                results += `<p>HTMLæ°´æé†’æ˜¾ç¤º: ${waterDisplay.value} åˆ†é’Ÿ</p>`;
                results += `<p>è®¾ç½®æ°´æé†’é—´éš”: ${settings.water.interval} åˆ†é’Ÿ</p>`;
                results += `<p>HTMLç«™ç«‹æé†’æ˜¾ç¤º: ${standupDisplay.value} åˆ†é’Ÿ</p>`;
                results += `<p>è®¾ç½®ç«™ç«‹æé†’é—´éš”: ${settings.standup.interval} åˆ†é’Ÿ</p>`;
                
                // éªŒè¯ä¸€è‡´æ€§
                const waterConsistent = waterDisplay.value == settings.water.interval;
                const standupConsistent = standupDisplay.value == settings.standup.interval;
                
                if (waterConsistent && standupConsistent) {
                    results += '<div class="result success">âœ… ä¿®å¤æˆåŠŸï¼HTMLæ˜¾ç¤ºå€¼ä¸è®¾ç½®å®Œå…¨ä¸€è‡´</div>';
                    results += '<div class="result info">ğŸ’¡ ç°åœ¨é¦–æ¬¡ç‚¹å‡»STARTåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„å€’è®¡æ—¶</div>';
                    log('ä¿®å¤éªŒè¯æˆåŠŸï¼šHTMLæ˜¾ç¤ºå€¼ä¸è®¾ç½®ä¸€è‡´', 'success');
                } else {
                    results += '<div class="result error">âŒ ä¿®å¤æœªå®Œå…¨ç”Ÿæ•ˆï¼Œä»å­˜åœ¨ä¸ä¸€è‡´</div>';
                    if (!waterConsistent) {
                        results += `<div class="result warning">æ°´æé†’ä¸ä¸€è‡´: HTML=${waterDisplay.value}, è®¾ç½®=${settings.water.interval}</div>`;
                    }
                    if (!standupConsistent) {
                        results += `<div class="result warning">ç«™ç«‹æé†’ä¸ä¸€è‡´: HTML=${standupDisplay.value}, è®¾ç½®=${settings.standup.interval}</div>`;
                    }
                    log('ä¿®å¤éªŒè¯å¤±è´¥ï¼šä»å­˜åœ¨ä¸ä¸€è‡´', 'error');
                }
                
                results += '</div>';
                
                document.getElementById('verify-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">éªŒè¯ä¿®å¤æ•ˆæœå¤±è´¥: ${error.message}</div>`;
                document.getElementById('verify-results').innerHTML = result;
                log(`éªŒè¯ä¿®å¤æ•ˆæœå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('åˆå§‹åŒ–ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('è¯·æŒ‰é¡ºåºæ‰§è¡Œï¼š1.æ¨¡æ‹Ÿåˆå§‹åŒ– â†’ 2.æµ‹è¯•å€’è®¡æ—¶ â†’ 3.éªŒè¯ä¿®å¤æ•ˆæœ');
        });
    </script>
</body>
</html>