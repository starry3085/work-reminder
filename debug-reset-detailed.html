<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细RESET按钮调试</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="app-container">
        <h1>详细RESET按钮调试</h1>
        
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <strong>调试说明:</strong> 这个页面会加载完整的应用代码，并添加详细的调试日志来追踪RESET按钮的问题。
        </div>
        
        <section class="reminders-section">
            <div class="reminder-card" id="water-card">
                <div class="card-header">
                    <div class="card-icon water-icon"></div>
                    <h3>Water Reminder</h3>
                    <div class="status-badge inactive" id="water-status-badge">Inactive</div>
                </div>
                <div class="card-content">
                    <div class="status-info">
                        <span class="next-reminder-label">Remind every:</span>
                        <div class="time-remaining" id="water-time">
                            <input type="number" id="water-interval-display" min="1" max="60" value="1" class="interval-input"> mins
                        </div>
                    </div>
                    <div class="daily-stats" id="water-stats">
                        <span class="stats-text">Today: 0/8 glasses</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="water-progress"></div>
                        </div>
                    </div>
                </div>
                <div class="card-controls">
                    <button class="btn-primary" id="water-toggle">Start</button>
                    <button class="btn-secondary" id="water-reset" style="display: none;">Reset</button>
                    <button class="btn-action" id="waterDrink" style="display: none;">Hydrated</button>
                </div>
            </div>

            <div class="reminder-card" id="standup-card">
                <div class="card-header">
                    <div class="card-icon standup-icon"></div>
                    <h3>Standup Reminder</h3>
                    <div class="status-badge inactive" id="standup-status-badge">Inactive</div>
                </div>
                <div class="card-content">
                    <div class="status-info">
                        <span class="next-reminder-label">Remind every:</span>
                        <div class="time-remaining" id="standup-time">
                            <input type="number" id="standup-interval-display" min="1" max="60" value="1" class="interval-input"> mins
                        </div>
                    </div>
                    <div class="daily-stats" id="standup-stats">
                        <span class="stats-text">Today: 0/8 activities</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="standup-progress"></div>
                        </div>
                    </div>
                </div>
                <div class="card-controls">
                    <button class="btn-primary" id="standup-toggle">Start</button>
                    <button class="btn-secondary" id="standup-reset" style="display: none;">Reset</button>
                    <button class="btn-action" id="standupActivity" style="display: none;">Moved</button>
                </div>
            </div>
        </section>
        
        <div style="margin-top: 20px;">
            <h3>调试控制</h3>
            <button onclick="debugElementCache()" class="btn-secondary">检查元素缓存</button>
            <button onclick="debugEventListeners()" class="btn-secondary">检查事件监听器</button>
            <button onclick="debugAppState()" class="btn-secondary">检查应用状态</button>
            <button onclick="clearDebugLog()" class="btn-secondary">清空日志</button>
        </div>
        
        <div id="debug-log" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <!-- 加载所有必需的JavaScript文件 -->
    <script src="js/debug-helper.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/notification-service.js"></script>
    <script src="js/activity-detector.js"></script>
    <script src="js/reminder-manager.js"></script>
    <script src="js/water-reminder.js"></script>
    <script src="js/standup-reminder.js"></script>
    <script src="js/mobile-adapter.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/app.js"></script>

    <script>
        // 调试日志函数
        function debugLog(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            logElement.textContent += `${prefix} [${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // 全局应用实例
        let debugApp = null;

        // 调试函数
        function debugElementCache() {
            if (!debugApp || !debugApp.uiController) {
                debugLog('应用或UI控制器未初始化', 'error');
                return;
            }

            const elements = debugApp.uiController.elements;
            debugLog('=== 元素缓存检查 ===');
            
            const resetButtons = ['waterReset', 'standupReset'];
            resetButtons.forEach(buttonId => {
                const element = elements[buttonId];
                if (element) {
                    debugLog(`✓ ${buttonId}: 元素存在, ID=${element.id}, 显示=${element.style.display}`, 'success');
                } else {
                    debugLog(`✗ ${buttonId}: 元素不存在`, 'error');
                }
            });
        }

        function debugEventListeners() {
            if (!debugApp || !debugApp.uiController) {
                debugLog('应用或UI控制器未初始化', 'error');
                return;
            }

            const eventListeners = debugApp.uiController.eventListeners;
            debugLog('=== 事件监听器检查 ===');
            
            const resetButtons = ['waterReset', 'standupReset'];
            resetButtons.forEach(buttonId => {
                if (eventListeners[buttonId] && eventListeners[buttonId]['click']) {
                    const listenerCount = eventListeners[buttonId]['click'].length;
                    debugLog(`✓ ${buttonId}: ${listenerCount}个click监听器`, 'success');
                } else {
                    debugLog(`✗ ${buttonId}: 没有click监听器`, 'error');
                }
            });
        }

        function debugAppState() {
            if (!debugApp) {
                debugLog('应用未初始化', 'error');
                return;
            }

            debugLog('=== 应用状态检查 ===');
            debugLog(`应用已初始化: ${debugApp.isInitialized}`);
            debugLog(`水提醒存在: ${!!debugApp.waterReminder}`);
            debugLog(`站立提醒存在: ${!!debugApp.standupReminder}`);
            debugLog(`UI控制器存在: ${!!debugApp.uiController}`);

            if (debugApp.waterReminder) {
                const waterStatus = debugApp.waterReminder.getCurrentStatus();
                debugLog(`水提醒状态: 活动=${waterStatus.isActive}, 暂停=${waterStatus.isPaused}`);
            }

            if (debugApp.standupReminder) {
                const standupStatus = debugApp.standupReminder.getCurrentStatus();
                debugLog(`站立提醒状态: 活动=${standupStatus.isActive}, 暂停=${standupStatus.isPaused}`);
            }
        }

        function clearDebugLog() {
            document.getElementById('debug-log').textContent = '';
        }

        // 重写一些关键方法来添加调试日志
        function addDebugLogging() {
            // 重写UIController的addEventHandler方法
            if (window.UIController && debugApp && debugApp.uiController) {
                const originalAddEventHandler = debugApp.uiController.addEventHandler;
                debugApp.uiController.addEventHandler = function(elementId, eventType, handler) {
                    debugLog(`绑定事件: ${elementId}.${eventType}`);
                    return originalAddEventHandler.call(this, elementId, eventType, handler);
                };

                // 重写triggerEvent方法
                const originalTriggerEvent = debugApp.uiController.triggerEvent;
                debugApp.uiController.triggerEvent = function(eventName, data) {
                    debugLog(`触发事件: ${eventName}`, 'success');
                    return originalTriggerEvent.call(this, eventName, data);
                };
            }

            // 重写应用的resetReminder方法
            if (debugApp && debugApp.resetReminder) {
                const originalResetReminder = debugApp.resetReminder;
                debugApp.resetReminder = function(type) {
                    debugLog(`调用resetReminder: ${type}`, 'success');
                    return originalResetReminder.call(this, type);
                };
            }
        }

        // 应用初始化
        async function initializeDebugApp() {
            try {
                debugLog('开始初始化调试应用...');

                // 检查必要的类是否存在
                const requiredClasses = [
                    'ErrorHandler', 'StorageManager', 'AppSettings',
                    'NotificationService', 'ActivityDetector', 'ReminderManager',
                    'WaterReminder', 'PostureReminder', 'UIController', 'MobileAdapter'
                ];

                const missingClasses = requiredClasses.filter(className => !window[className]);
                if (missingClasses.length > 0) {
                    throw new Error(`缺少必需的类: ${missingClasses.join(', ')}`);
                }

                debugLog('所有必需的类都已加载', 'success');

                // 创建应用实例
                debugApp = new OfficeWellnessApp();
                
                // 添加调试日志
                addDebugLogging();
                
                // 初始化应用
                await debugApp.initialize();
                
                debugLog('应用初始化完成', 'success');
                debugLog('请点击Start按钮启动提醒，然后测试Reset按钮');

            } catch (error) {
                debugLog(`应用初始化失败: ${error.message}`, 'error');
                console.error('Debug app initialization failed:', error);
            }
        }

        // DOM加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDebugApp);
        } else {
            initializeDebugApp();
        }

        // 全局错误处理
        window.addEventListener('error', function(event) {
            debugLog(`全局错误: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            debugLog(`未处理的Promise拒绝: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>