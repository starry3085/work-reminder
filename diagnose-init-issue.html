<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå§‹åŒ–æ—¶åºé—®é¢˜è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnose-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åˆå§‹åŒ–æ—¶åºé—®é¢˜è¯Šæ–­</h1>
    
    <div class="diagnose-section">
        <h2>é—®é¢˜æè¿°</h2>
        <div class="result warning">
            <strong>ç°è±¡ï¼š</strong>
            <ul>
                <li>å¼ºåˆ¶åˆ·æ–°åé¦–æ¬¡ç‚¹STARTï¼šå€’è®¡æ—¶é€»è¾‘ä¸å¯¹</li>
                <li>æ‰‹åŠ¨ä¿®æ”¹æ—¶é—´åï¼šå€’è®¡æ—¶é€»è¾‘æ­£ç¡®</li>
            </ul>
            <strong>æ¨æµ‹åŸå› ï¼š</strong> UIæ˜¾ç¤ºå€¼ä¸å®é™…è®¾ç½®å€¼åœ¨åˆå§‹åŒ–æ—¶ä¸åŒæ­¥
        </div>
    </div>

    <div class="diagnose-section">
        <h2>è¯Šæ–­æ­¥éª¤</h2>
        <button class="btn btn-primary" onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <div id="diagnosis-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>æ¨¡æ‹Ÿåˆå§‹åŒ–æµç¨‹</h2>
        <button class="btn btn-success" onclick="simulateInitFlow()">æ¨¡æ‹Ÿåˆå§‹åŒ–æµç¨‹</button>
        <div id="init-flow-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>ä¿®å¤æ–¹æ¡ˆ</h2>
        <button class="btn btn-danger" onclick="applyFix()">åº”ç”¨ä¿®å¤</button>
        <div id="fix-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>è¯¦ç»†æ—¥å¿—</h2>
        <button class="btn btn-primary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <pre id="debug-log"></pre>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        function runFullDiagnosis() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...');
            
            try {
                let results = '<div class="step"><h3>æ­¥éª¤1: æ£€æŸ¥HTMLåˆå§‹å€¼</h3>';
                
                // åˆ›å»ºæ¨¡æ‹ŸHTMLå…ƒç´ 
                const waterInput = document.createElement('input');
                waterInput.type = 'number';
                waterInput.id = 'water-interval-display';
                waterInput.value = '30'; // HTMLä¸­çš„åˆå§‹å€¼
                
                const standupInput = document.createElement('input');
                standupInput.type = 'number';
                standupInput.id = 'standup-interval-display';
                standupInput.value = '30'; // HTMLä¸­çš„åˆå§‹å€¼
                
                results += `<div class="result info">HTMLæ°´æé†’åˆå§‹å€¼: ${waterInput.value} åˆ†é’Ÿ</div>`;
                results += `<div class="result info">HTMLç«™ç«‹æé†’åˆå§‹å€¼: ${standupInput.value} åˆ†é’Ÿ</div>`;
                results += '</div>';
                
                log(`HTMLåˆå§‹å€¼ - æ°´æé†’: ${waterInput.value}, ç«™ç«‹æé†’: ${standupInput.value}`);
                
                // æ­¥éª¤2: æ£€æŸ¥é»˜è®¤è®¾ç½®
                results += '<div class="step"><h3>æ­¥éª¤2: æ£€æŸ¥é»˜è®¤è®¾ç½®</h3>';
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const defaultSettings = appSettings.getSettings();
                
                results += `<div class="result info">é»˜è®¤æ°´æé†’é—´éš”: ${defaultSettings.water.interval} åˆ†é’Ÿ</div>`;
                results += `<div class="result info">é»˜è®¤ç«™ç«‹æé†’é—´éš”: ${defaultSettings.standup.interval} åˆ†é’Ÿ</div>`;
                results += '</div>';
                
                log(`é»˜è®¤è®¾ç½® - æ°´æé†’: ${defaultSettings.water.interval}, ç«™ç«‹æé†’: ${defaultSettings.standup.interval}`);
                
                // æ­¥éª¤3: æ£€æŸ¥localStorageä¸­çš„è®¾ç½®
                results += '<div class="step"><h3>æ­¥éª¤3: æ£€æŸ¥localStorageè®¾ç½®</h3>';
                const savedSettings = storageManager.loadSettings('appSettings');
                if (savedSettings) {
                    results += `<div class="result info">localStorageæ°´æé†’é—´éš”: ${savedSettings.water?.interval || 'æœªè®¾ç½®'} åˆ†é’Ÿ</div>`;
                    results += `<div class="result info">localStorageç«™ç«‹æé†’é—´éš”: ${savedSettings.standup?.interval || 'æœªè®¾ç½®'} åˆ†é’Ÿ</div>`;
                    log(`localStorageè®¾ç½® - æ°´æé†’: ${savedSettings.water?.interval}, ç«™ç«‹æé†’: ${savedSettings.standup?.interval}`);
                } else {
                    results += '<div class="result warning">localStorageä¸­æ²¡æœ‰ä¿å­˜çš„è®¾ç½®</div>';
                    log('localStorageä¸­æ²¡æœ‰ä¿å­˜çš„è®¾ç½®');
                }
                results += '</div>';
                
                // æ­¥éª¤4: åˆ†æä¸ä¸€è‡´æ€§
                results += '<div class="step"><h3>æ­¥éª¤4: åˆ†æé—®é¢˜</h3>';
                
                const htmlWaterValue = parseInt(waterInput.value);
                const defaultWaterValue = defaultSettings.water.interval;
                const savedWaterValue = savedSettings?.water?.interval;
                
                if (htmlWaterValue !== defaultWaterValue) {
                    results += '<div class="result error">âŒ HTMLåˆå§‹å€¼ä¸é»˜è®¤è®¾ç½®ä¸ä¸€è‡´</div>';
                    log('å‘ç°é—®é¢˜: HTMLåˆå§‹å€¼ä¸é»˜è®¤è®¾ç½®ä¸ä¸€è‡´', 'error');
                } else if (savedWaterValue && savedWaterValue !== htmlWaterValue) {
                    results += '<div class="result error">âŒ HTMLåˆå§‹å€¼ä¸ä¿å­˜çš„è®¾ç½®ä¸ä¸€è‡´</div>';
                    log('å‘ç°é—®é¢˜: HTMLåˆå§‹å€¼ä¸ä¿å­˜çš„è®¾ç½®ä¸ä¸€è‡´', 'error');
                } else {
                    results += '<div class="result success">âœ… å€¼ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡</div>';
                    log('å€¼ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡');
                }
                
                results += '</div>';
                
                document.getElementById('diagnosis-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">è¯Šæ–­å¤±è´¥: ${error.message}</div>`;
                document.getElementById('diagnosis-results').innerHTML = result;
                log(`è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateInitFlow() {
            log('å¼€å§‹æ¨¡æ‹Ÿåˆå§‹åŒ–æµç¨‹...');
            
            try {
                let results = '<div class="step"><h3>æ¨¡æ‹Ÿåº”ç”¨åˆå§‹åŒ–æµç¨‹</h3>';
                
                // æ­¥éª¤1: æ¨¡æ‹ŸloadSettings
                results += '<h4>1. loadSettings()</h4>';
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¼ºåˆ¶åˆ·æ–°
                const isForceRefresh = appSettings.detectForceRefresh();
                results += `<div class="result info">æ£€æµ‹å¼ºåˆ¶åˆ·æ–°: ${isForceRefresh}</div>`;
                log(`æ£€æµ‹å¼ºåˆ¶åˆ·æ–°: ${isForceRefresh}`);
                
                const settings = appSettings.loadSettings();
                results += `<div class="result info">åŠ è½½çš„è®¾ç½® - æ°´æé†’: ${settings.water.interval}åˆ†é’Ÿ</div>`;
                log(`åŠ è½½çš„è®¾ç½® - æ°´æé†’: ${settings.water.interval}åˆ†é’Ÿ`);
                
                // æ­¥éª¤2: æ¨¡æ‹ŸUIåˆå§‹åŒ–
                results += '<h4>2. UIåˆå§‹åŒ–</h4>';
                
                // åˆ›å»ºæ¨¡æ‹ŸHTMLå…ƒç´ 
                const waterInput = document.createElement('input');
                waterInput.type = 'number';
                waterInput.id = 'water-interval-display';
                waterInput.value = '30'; // HTMLåˆå§‹å€¼
                
                results += `<div class="result info">UIåˆå§‹åŒ–å‰ - HTMLæ˜¾ç¤ºå€¼: ${waterInput.value}åˆ†é’Ÿ</div>`;
                log(`UIåˆå§‹åŒ–å‰ - HTMLæ˜¾ç¤ºå€¼: ${waterInput.value}åˆ†é’Ÿ`);
                
                // æ­¥éª¤3: æ¨¡æ‹ŸapplySettingsToUI
                results += '<h4>3. applySettingsToUI()</h4>';
                const oldValue = waterInput.value;
                waterInput.value = settings.water.interval || 30;
                const newValue = waterInput.value;
                
                results += `<div class="result ${oldValue !== newValue ? 'warning' : 'success'}">`;
                results += `HTMLå€¼æ›´æ–°: ${oldValue} â†’ ${newValue}`;
                results += '</div>';
                
                log(`applySettingsToUI: HTMLå€¼ä» ${oldValue} æ›´æ–°ä¸º ${newValue}`);
                
                // æ­¥éª¤4: åˆ†æé—®é¢˜
                results += '<h4>4. é—®é¢˜åˆ†æ</h4>';
                if (oldValue !== newValue) {
                    results += '<div class="result warning">âš ï¸ å‘ç°é—®é¢˜: HTMLåˆå§‹å€¼ä¸è®¾ç½®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨applySettingsToUIä¸­åŒæ­¥</div>';
                    results += '<div class="result info">ğŸ’¡ è§£å†³æ–¹æ¡ˆ: ç¡®ä¿applySettingsToUIæ­£ç¡®æ‰§è¡Œå¹¶æ›´æ–°æ‰€æœ‰ç›¸å…³å…ƒç´ </div>';
                    log('å‘ç°é—®é¢˜: HTMLåˆå§‹å€¼ä¸è®¾ç½®ä¸ä¸€è‡´', 'warning');
                } else {
                    results += '<div class="result success">âœ… HTMLå€¼ä¸è®¾ç½®ä¸€è‡´</div>';
                    log('HTMLå€¼ä¸è®¾ç½®ä¸€è‡´');
                }
                
                results += '</div>';
                
                document.getElementById('init-flow-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">æ¨¡æ‹Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                document.getElementById('init-flow-results').innerHTML = result;
                log(`æ¨¡æ‹Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function applyFix() {
            log('å¼€å§‹åº”ç”¨ä¿®å¤æ–¹æ¡ˆ...');
            
            try {
                let results = '<div class="step"><h3>ä¿®å¤æ–¹æ¡ˆ</h3>';
                
                results += '<h4>é—®é¢˜æ ¹å› </h4>';
                results += '<div class="result warning">åˆå§‹åŒ–æ—¶åºé—®é¢˜ï¼šHTMLåˆå§‹å€¼ä¸å®é™…è®¾ç½®ä¸åŒæ­¥</div>';
                
                results += '<h4>ä¿®å¤æ­¥éª¤</h4>';
                results += '<ol>';
                results += '<li><strong>ç¡®ä¿applySettingsToUIæ­£ç¡®æ‰§è¡Œï¼š</strong> åœ¨UIåˆå§‹åŒ–åç«‹å³åº”ç”¨è®¾ç½®</li>';
                results += '<li><strong>æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼š</strong> ç¡®è®¤è®¾ç½®åŒæ­¥è¿‡ç¨‹</li>';
                results += '<li><strong>å¼ºåˆ¶UIæ›´æ–°ï¼š</strong> ç¡®ä¿HTMLå…ƒç´ å€¼è¢«æ­£ç¡®æ›´æ–°</li>';
                results += '</ol>';
                
                results += '<h4>ä»£ç ä¿®å¤å»ºè®®</h4>';
                results += '<pre>';
                results += `// åœ¨js/app.jsçš„initializeUIæ–¹æ³•ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
initializeUI() {
    this.uiController.initialize();
    
    const currentSettings = this.appSettings.getSettings();
    console.log('åº”ç”¨è®¾ç½®åˆ°UI:', currentSettings);
    
    this.uiController.applySettingsToUI(currentSettings);
    
    // éªŒè¯è®¾ç½®æ˜¯å¦æ­£ç¡®åº”ç”¨
    const waterDisplay = document.getElementById('water-interval-display');
    const standupDisplay = document.getElementById('standup-interval-display');
    
    console.log('UIæ›´æ–°å - æ°´æé†’æ˜¾ç¤ºå€¼:', waterDisplay?.value);
    console.log('UIæ›´æ–°å - ç«™ç«‹æé†’æ˜¾ç¤ºå€¼:', standupDisplay?.value);
    
    this.setupUIEventHandlers();
}`;
                results += '</pre>';
                
                results += '<div class="result success">âœ… ä¿®å¤æ–¹æ¡ˆå·²ç”Ÿæˆï¼Œè¯·æ‰‹åŠ¨åº”ç”¨åˆ°ä»£ç ä¸­</div>';
                results += '</div>';
                
                document.getElementById('fix-results').innerHTML = results;
                log('ä¿®å¤æ–¹æ¡ˆå·²ç”Ÿæˆ');
                
            } catch (error) {
                const result = `<div class="result error">ç”Ÿæˆä¿®å¤æ–¹æ¡ˆå¤±è´¥: ${error.message}</div>`;
                document.getElementById('fix-results').innerHTML = result;
                log(`ç”Ÿæˆä¿®å¤æ–¹æ¡ˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('åˆå§‹åŒ–æ—¶åºé—®é¢˜è¯Šæ–­é¡µé¢å·²åŠ è½½');
            log('è¯·ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"å¼€å§‹åˆ†æé—®é¢˜');
        });
    </script>
</body>
</html>