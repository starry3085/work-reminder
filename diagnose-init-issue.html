<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始化时序问题诊断</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnose-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>🔍 初始化时序问题诊断</h1>
    
    <div class="diagnose-section">
        <h2>问题描述</h2>
        <div class="result warning">
            <strong>现象：</strong>
            <ul>
                <li>强制刷新后首次点START：倒计时逻辑不对</li>
                <li>手动修改时间后：倒计时逻辑正确</li>
            </ul>
            <strong>推测原因：</strong> UI显示值与实际设置值在初始化时不同步
        </div>
    </div>

    <div class="diagnose-section">
        <h2>诊断步骤</h2>
        <button class="btn btn-primary" onclick="runFullDiagnosis()">运行完整诊断</button>
        <div id="diagnosis-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>模拟初始化流程</h2>
        <button class="btn btn-success" onclick="simulateInitFlow()">模拟初始化流程</button>
        <div id="init-flow-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>修复方案</h2>
        <button class="btn btn-danger" onclick="applyFix()">应用修复</button>
        <div id="fix-results"></div>
    </div>

    <div class="diagnose-section">
        <h2>详细日志</h2>
        <button class="btn btn-primary" onclick="clearLog()">清除日志</button>
        <pre id="debug-log"></pre>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        function runFullDiagnosis() {
            log('开始运行完整诊断...');
            
            try {
                let results = '<div class="step"><h3>步骤1: 检查HTML初始值</h3>';
                
                // 创建模拟HTML元素
                const waterInput = document.createElement('input');
                waterInput.type = 'number';
                waterInput.id = 'water-interval-display';
                waterInput.value = '30'; // HTML中的初始值
                
                const standupInput = document.createElement('input');
                standupInput.type = 'number';
                standupInput.id = 'standup-interval-display';
                standupInput.value = '30'; // HTML中的初始值
                
                results += `<div class="result info">HTML水提醒初始值: ${waterInput.value} 分钟</div>`;
                results += `<div class="result info">HTML站立提醒初始值: ${standupInput.value} 分钟</div>`;
                results += '</div>';
                
                log(`HTML初始值 - 水提醒: ${waterInput.value}, 站立提醒: ${standupInput.value}`);
                
                // 步骤2: 检查默认设置
                results += '<div class="step"><h3>步骤2: 检查默认设置</h3>';
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                const defaultSettings = appSettings.getSettings();
                
                results += `<div class="result info">默认水提醒间隔: ${defaultSettings.water.interval} 分钟</div>`;
                results += `<div class="result info">默认站立提醒间隔: ${defaultSettings.standup.interval} 分钟</div>`;
                results += '</div>';
                
                log(`默认设置 - 水提醒: ${defaultSettings.water.interval}, 站立提醒: ${defaultSettings.standup.interval}`);
                
                // 步骤3: 检查localStorage中的设置
                results += '<div class="step"><h3>步骤3: 检查localStorage设置</h3>';
                const savedSettings = storageManager.loadSettings('appSettings');
                if (savedSettings) {
                    results += `<div class="result info">localStorage水提醒间隔: ${savedSettings.water?.interval || '未设置'} 分钟</div>`;
                    results += `<div class="result info">localStorage站立提醒间隔: ${savedSettings.standup?.interval || '未设置'} 分钟</div>`;
                    log(`localStorage设置 - 水提醒: ${savedSettings.water?.interval}, 站立提醒: ${savedSettings.standup?.interval}`);
                } else {
                    results += '<div class="result warning">localStorage中没有保存的设置</div>';
                    log('localStorage中没有保存的设置');
                }
                results += '</div>';
                
                // 步骤4: 分析不一致性
                results += '<div class="step"><h3>步骤4: 分析问题</h3>';
                
                const htmlWaterValue = parseInt(waterInput.value);
                const defaultWaterValue = defaultSettings.water.interval;
                const savedWaterValue = savedSettings?.water?.interval;
                
                if (htmlWaterValue !== defaultWaterValue) {
                    results += '<div class="result error">❌ HTML初始值与默认设置不一致</div>';
                    log('发现问题: HTML初始值与默认设置不一致', 'error');
                } else if (savedWaterValue && savedWaterValue !== htmlWaterValue) {
                    results += '<div class="result error">❌ HTML初始值与保存的设置不一致</div>';
                    log('发现问题: HTML初始值与保存的设置不一致', 'error');
                } else {
                    results += '<div class="result success">✅ 值一致性检查通过</div>';
                    log('值一致性检查通过');
                }
                
                results += '</div>';
                
                document.getElementById('diagnosis-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">诊断失败: ${error.message}</div>`;
                document.getElementById('diagnosis-results').innerHTML = result;
                log(`诊断失败: ${error.message}`, 'error');
            }
        }

        function simulateInitFlow() {
            log('开始模拟初始化流程...');
            
            try {
                let results = '<div class="step"><h3>模拟应用初始化流程</h3>';
                
                // 步骤1: 模拟loadSettings
                results += '<h4>1. loadSettings()</h4>';
                const storageManager = new StorageManager();
                const appSettings = new AppSettings(storageManager);
                
                // 检查是否为强制刷新
                const isForceRefresh = appSettings.detectForceRefresh();
                results += `<div class="result info">检测强制刷新: ${isForceRefresh}</div>`;
                log(`检测强制刷新: ${isForceRefresh}`);
                
                const settings = appSettings.loadSettings();
                results += `<div class="result info">加载的设置 - 水提醒: ${settings.water.interval}分钟</div>`;
                log(`加载的设置 - 水提醒: ${settings.water.interval}分钟`);
                
                // 步骤2: 模拟UI初始化
                results += '<h4>2. UI初始化</h4>';
                
                // 创建模拟HTML元素
                const waterInput = document.createElement('input');
                waterInput.type = 'number';
                waterInput.id = 'water-interval-display';
                waterInput.value = '30'; // HTML初始值
                
                results += `<div class="result info">UI初始化前 - HTML显示值: ${waterInput.value}分钟</div>`;
                log(`UI初始化前 - HTML显示值: ${waterInput.value}分钟`);
                
                // 步骤3: 模拟applySettingsToUI
                results += '<h4>3. applySettingsToUI()</h4>';
                const oldValue = waterInput.value;
                waterInput.value = settings.water.interval || 30;
                const newValue = waterInput.value;
                
                results += `<div class="result ${oldValue !== newValue ? 'warning' : 'success'}">`;
                results += `HTML值更新: ${oldValue} → ${newValue}`;
                results += '</div>';
                
                log(`applySettingsToUI: HTML值从 ${oldValue} 更新为 ${newValue}`);
                
                // 步骤4: 分析问题
                results += '<h4>4. 问题分析</h4>';
                if (oldValue !== newValue) {
                    results += '<div class="result warning">⚠️ 发现问题: HTML初始值与设置不一致，需要在applySettingsToUI中同步</div>';
                    results += '<div class="result info">💡 解决方案: 确保applySettingsToUI正确执行并更新所有相关元素</div>';
                    log('发现问题: HTML初始值与设置不一致', 'warning');
                } else {
                    results += '<div class="result success">✅ HTML值与设置一致</div>';
                    log('HTML值与设置一致');
                }
                
                results += '</div>';
                
                document.getElementById('init-flow-results').innerHTML = results;
                
            } catch (error) {
                const result = `<div class="result error">模拟初始化失败: ${error.message}</div>`;
                document.getElementById('init-flow-results').innerHTML = result;
                log(`模拟初始化失败: ${error.message}`, 'error');
            }
        }

        function applyFix() {
            log('开始应用修复方案...');
            
            try {
                let results = '<div class="step"><h3>修复方案</h3>';
                
                results += '<h4>问题根因</h4>';
                results += '<div class="result warning">初始化时序问题：HTML初始值与实际设置不同步</div>';
                
                results += '<h4>修复步骤</h4>';
                results += '<ol>';
                results += '<li><strong>确保applySettingsToUI正确执行：</strong> 在UI初始化后立即应用设置</li>';
                results += '<li><strong>添加调试日志：</strong> 确认设置同步过程</li>';
                results += '<li><strong>强制UI更新：</strong> 确保HTML元素值被正确更新</li>';
                results += '</ol>';
                
                results += '<h4>代码修复建议</h4>';
                results += '<pre>';
                results += `// 在js/app.js的initializeUI方法中添加调试日志
initializeUI() {
    this.uiController.initialize();
    
    const currentSettings = this.appSettings.getSettings();
    console.log('应用设置到UI:', currentSettings);
    
    this.uiController.applySettingsToUI(currentSettings);
    
    // 验证设置是否正确应用
    const waterDisplay = document.getElementById('water-interval-display');
    const standupDisplay = document.getElementById('standup-interval-display');
    
    console.log('UI更新后 - 水提醒显示值:', waterDisplay?.value);
    console.log('UI更新后 - 站立提醒显示值:', standupDisplay?.value);
    
    this.setupUIEventHandlers();
}`;
                results += '</pre>';
                
                results += '<div class="result success">✅ 修复方案已生成，请手动应用到代码中</div>';
                results += '</div>';
                
                document.getElementById('fix-results').innerHTML = results;
                log('修复方案已生成');
                
            } catch (error) {
                const result = `<div class="result error">生成修复方案失败: ${error.message}</div>`;
                document.getElementById('fix-results').innerHTML = result;
                log(`生成修复方案失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('初始化时序问题诊断页面已加载');
            log('请点击"运行完整诊断"开始分析问题');
        });
    </script>
</body>
</html>