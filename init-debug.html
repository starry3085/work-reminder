<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialization Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Application Initialization Debug</h1>
    
    <button onclick="testInit()">Test Initialization</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <!-- Required elements -->
    <div id="app-status-indicator" style="display: none;"></div>
    <div id="app-status-text" style="display: none;"></div>
    <div id="water-card" style="display: none;"></div>
    <div id="posture-card" style="display: none;"></div>
    <div id="water-status-badge" style="display: none;"></div>
    <div id="posture-status-badge" style="display: none;"></div>
    <div id="water-time" style="display: none;"></div>
    <div id="posture-time" style="display: none;"></div>
    <div id="water-toggle" style="display: none;"></div>
    <div id="posture-toggle" style="display: none;"></div>
    <div id="settings-panel" style="display: none;"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            log(`SCRIPT ERROR: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            log(`PROMISE ERROR: ${e.reason}`, 'error');
        });
        
        async function testInit() {
            log('Starting initialization test...');
            
            // Test 1: Load scripts one by one
            const scripts = [
                'js/storage-manager.js',
                'js/app-settings.js',
                'js/notification-service.js',
                'js/activity-detector.js',
                'js/reminder-manager.js',
                'js/water-reminder.js',
                'js/standup-reminder.js',
                'js/ui-controller.js',
                'js/app.js'
            ];
            
            for (const scriptSrc of scripts) {
                try {
                    await loadScript(scriptSrc);
                    log(`✓ Loaded: ${scriptSrc}`, 'success');
                } catch (error) {
                    log(`✗ Failed to load: ${scriptSrc} - ${error.message}`, 'error');
                    return;
                }
            }
            
            // Test 2: Check if classes are available
            const classes = [
                'StorageManager',
                'AppSettings', 
                'NotificationService',
                'ActivityDetector',
                'ReminderManager',
                'WaterReminder',
                'PostureReminder',
                'UIController',
                'OfficeWellnessApp'
            ];
            
            for (const className of classes) {
                if (typeof window[className] !== 'undefined') {
                    log(`✓ Class available: ${className}`, 'success');
                } else {
                    log(`✗ Class missing: ${className}`, 'error');
                }
            }
            
            // Test 3: Try to create app instance
            try {
                log('Creating OfficeWellnessApp instance...');
                const app = new OfficeWellnessApp();
                log('✓ App instance created successfully', 'success');
                
                // Test 4: Try to initialize
                log('Initializing app...');
                await app.initialize();
                log('✓ App initialized successfully!', 'success');
                
            } catch (error) {
                log(`✗ App initialization failed: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }
        
        log('Debug page loaded. Click "Test Initialization" to start.');
    </script>
</body>
</html>