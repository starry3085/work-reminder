<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>应用诊断测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 应用诊断测试</h1>
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }
        
        function logDetail(title, data) {
            const div = document.createElement('div');
            div.className = 'log';
            div.innerHTML = `<strong>${title}:</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
            results.appendChild(div);
        }
        
        // 检查脚本加载
        function checkScriptLoading() {
            log('<h3>📁 检查脚本文件加载</h3>');
            
            const scripts = [
                'js/debug-helper.js',
                'js/error-handler.js', 
                'js/storage-manager.js',
                'js/app-settings.js',
                'js/notification-service.js',
                'js/activity-detector.js',
                'js/reminder-manager.js',
                'js/water-reminder.js',
                'js/standup-reminder.js',
                'js/mobile-adapter.js',
                'js/ui-controller.js',
                'js/app.js'
            ];
            
            let loadedCount = 0;
            let totalCount = scripts.length;
            
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedCount++;
                    log(`✅ ${src} 加载成功`, 'success');
                    
                    if (loadedCount === totalCount) {
                        setTimeout(checkClasses, 100);
                    }
                };
                script.onerror = () => {
                    log(`❌ ${src} 加载失败`, 'error');
                    loadedCount++;
                    
                    if (loadedCount === totalCount) {
                        setTimeout(checkClasses, 100);
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // 检查类定义
        function checkClasses() {
            log('<h3>🏗️ 检查类定义</h3>');
            
            const requiredClasses = [
                'DebugHelper',
                'ErrorHandler',
                'StorageManager', 
                'AppSettings',
                'NotificationService',
                'ActivityDetector',
                'ReminderManager',
                'WaterReminder',
                'PostureReminder',
                'UIController',
                'MobileAdapter',
                'OfficeWellnessApp'
            ];
            
            const classStatus = {};
            let allClassesAvailable = true;
            
            requiredClasses.forEach(className => {
                const isAvailable = typeof window[className] !== 'undefined';
                classStatus[className] = isAvailable;
                
                if (isAvailable) {
                    log(`✅ ${className} 类可用`, 'success');
                } else {
                    log(`❌ ${className} 类缺失`, 'error');
                    allClassesAvailable = false;
                }
            });
            
            logDetail('类可用性状态', classStatus);
            
            if (allClassesAvailable) {
                setTimeout(runDiagnostics, 100);
            } else {
                log('❌ 部分必要类缺失，无法继续测试', 'error');
            }
        }
        
        // 运行诊断
        async function runDiagnostics() {
            log('<h3>🔍 运行系统诊断</h3>');
            
            try {
                if (typeof DebugHelper !== 'undefined') {
                    const debugHelper = new DebugHelper();
                    const diagnostics = await debugHelper.runDiagnostics();
                    
                    logDetail('诊断结果', diagnostics);
                    
                    if (diagnostics.overall.status === 'success') {
                        log('✅ 系统诊断通过', 'success');
                        setTimeout(testAppCreation, 100);
                    } else {
                        log(`⚠️ 系统诊断发现问题: ${diagnostics.overall.status}`, 'warning');
                        setTimeout(testAppCreation, 100);
                    }
                } else {
                    log('❌ DebugHelper 不可用，跳过诊断', 'error');
                    setTimeout(testAppCreation, 100);
                }
            } catch (error) {
                log(`❌ 诊断运行失败: ${error.message}`, 'error');
                console.error('诊断错误:', error);
                setTimeout(testAppCreation, 100);
            }
        }
        
        // 测试应用创建
        async function testAppCreation() {
            log('<h3>🚀 测试应用创建和初始化</h3>');
            
            try {
                // 创建应用实例
                log('创建 OfficeWellnessApp 实例...');
                const app = new OfficeWellnessApp();
                log('✅ 应用实例创建成功', 'success');
                
                // 尝试初始化
                log('初始化应用...');
                await app.initialize();
                log('✅ 应用初始化成功！', 'success');
                
                // 获取应用状态
                const status = app.getCurrentStatus ? app.getCurrentStatus() : '状态方法不可用';
                logDetail('应用状态', status);
                
                log('<h2>🎉 所有测试通过！应用运行正常</h2>', 'success');
                
            } catch (error) {
                log(`❌ 应用测试失败: ${error.message}`, 'error');
                console.error('应用错误详情:', error);
                
                // 显示错误堆栈
                if (error.stack) {
                    logDetail('错误堆栈', error.stack);
                }
            }
        }
        
        // 开始测试
        log('🔄 开始加载和测试应用组件...');
        checkScriptLoading();
    </script>
</body>
</html>