<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .countdown-display {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 15px 0;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .interval-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .status-display {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .fix-summary {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>å–æ°´æé†’å€’è®¡æ—¶é—®é¢˜ - æœ€ç»ˆä¿®å¤éªŒè¯</h1>
    
    <div class="fix-summary">
        <h2>ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜</h2>
        <ul>
            <li><strong>ä¿®å¤1ï¼š</strong> HTMLä¸­æ°´æé†’é—´éš”åˆå§‹å€¼ä»1åˆ†é’Ÿæ”¹ä¸º30åˆ†é’Ÿ</li>
            <li><strong>ä¿®å¤2ï¼š</strong> UIæ§åˆ¶å™¨ä¸­è®¾ç½®åŒæ­¥é—®é¢˜ï¼ˆsettings.posture â†’ settings.standupï¼‰</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª å®Œæ•´åŠŸèƒ½æµ‹è¯•</h2>
        <div>
            <label><strong>è®¾ç½®é—´éš”:</strong> 
                <input type="number" id="water-interval" min="1" max="60" value="1" class="interval-input"> åˆ†é’Ÿ
            </label>
            <button class="btn btn-primary" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
            <button class="btn btn-danger" onclick="stopTest()">åœæ­¢æµ‹è¯•</button>
        </div>
        
        <div class="countdown-display" id="countdown-display">--:--</div>
        
        <div class="status-display" id="status-display">
            çŠ¶æ€: æœªå¼€å§‹æµ‹è¯•
        </div>
        
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ</h2>
        <div id="analysis-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <button class="btn btn-success" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <pre id="test-log"></pre>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script src="js/notification-service.js"></script>
    <script src="js/reminder-manager.js"></script>
    <script src="js/water-reminder.js"></script>

    <script>
        let waterReminder = null;
        let updateTimer = null;
        let testStartTime = null;
        let expectedInterval = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }

        function updateCountdown(timeRemaining) {
            const countdownElement = document.getElementById('countdown-display');
            
            if (timeRemaining <= 0) {
                countdownElement.textContent = '--:--';
                countdownElement.style.color = '#6c757d';
            } else {
                const minutes = Math.floor(timeRemaining / 60000);
                const seconds = Math.floor((timeRemaining % 60000) / 1000);
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // æ ¹æ®å‰©ä½™æ—¶é—´è®¾ç½®é¢œè‰²
                if (timeRemaining < 60000) { // å°äº1åˆ†é’Ÿ
                    countdownElement.style.color = '#dc3545'; // çº¢è‰²
                } else if (timeRemaining < 300000) { // å°äº5åˆ†é’Ÿ
                    countdownElement.style.color = '#fd7e14'; // æ©™è‰²
                } else {
                    countdownElement.style.color = '#007bff'; // è“è‰²
                }
            }
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status-display');
            statusElement.textContent = message;
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            statusElement.className = 'status-display';
            if (type === 'success') {
                statusElement.style.borderLeftColor = '#28a745';
                statusElement.style.backgroundColor = '#d4edda';
            } else if (type === 'error') {
                statusElement.style.borderLeftColor = '#dc3545';
                statusElement.style.backgroundColor = '#f8d7da';
            } else if (type === 'warning') {
                statusElement.style.borderLeftColor = '#ffc107';
                statusElement.style.backgroundColor = '#fff3cd';
            } else {
                statusElement.style.borderLeftColor = '#007bff';
                statusElement.style.backgroundColor = '#f8f9fa';
            }
        }

        function startTest() {
            try {
                expectedInterval = parseInt(document.getElementById('water-interval').value);
                testStartTime = Date.now();
                
                log(`å¼€å§‹æµ‹è¯• - è®¾ç½®é—´éš”: ${expectedInterval}åˆ†é’Ÿ`);
                updateStatus(`æ­£åœ¨å¯åŠ¨æµ‹è¯•... è®¾ç½®é—´éš”: ${expectedInterval}åˆ†é’Ÿ`);

                // åˆ›å»ºé€šçŸ¥æœåŠ¡
                const notificationService = {
                    showNotification: (type, title, message) => {
                        log(`é€šçŸ¥è§¦å‘: ${title} - ${message}`);
                        updateStatus(`æé†’è§¦å‘: ${title}`, 'warning');
                        
                        // åˆ†æç»“æœ
                        analyzeResults('reminder_triggered');
                    },
                    showInPageAlert: (type, options) => {
                        log(`é¡µé¢æé†’: ${options.title} - ${options.message}`);
                    }
                };

                // åˆ›å»ºæ°´æé†’è®¾ç½®
                const waterSettings = {
                    enabled: true,
                    interval: expectedInterval,
                    sound: true,
                    lastReminder: null,
                    target: 8
                };

                // åˆ›å»ºæ°´æé†’å®ä¾‹
                waterReminder = new WaterReminder(waterSettings, notificationService);

                // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
                waterReminder.setStatusChangeCallback((status) => {
                    log(`çŠ¶æ€å˜åŒ–: ${status.status}, æ´»è·ƒ: ${status.isActive}, å‰©ä½™: ${Math.floor(status.timeRemaining/1000)}ç§’`);
                    
                    if (status.status === 'started') {
                        const actualMinutes = Math.floor(status.timeRemaining / 60000);
                        const actualSeconds = Math.floor((status.timeRemaining % 60000) / 1000);
                        
                        updateStatus(`æµ‹è¯•è¿›è¡Œä¸­ - å€’è®¡æ—¶: ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`, 'info');
                        
                        // æ£€æŸ¥åˆå§‹å€’è®¡æ—¶æ˜¯å¦æ­£ç¡®
                        if (actualMinutes === expectedInterval && actualSeconds === 0) {
                            log(`âœ… åˆå§‹å€’è®¡æ—¶æ­£ç¡®: ${actualMinutes}:00`, 'success');
                            analyzeResults('correct_initial_countdown');
                        } else {
                            log(`âŒ åˆå§‹å€’è®¡æ—¶é”™è¯¯: é¢„æœŸ ${expectedInterval}:00, å®é™… ${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`, 'error');
                            analyzeResults('incorrect_initial_countdown', {
                                expected: `${expectedInterval}:00`,
                                actual: `${actualMinutes}:${actualSeconds.toString().padStart(2, '0')}`
                            });
                        }
                    }
                });

                // è®¾ç½®æ—¶é—´æ›´æ–°å›è°ƒ
                waterReminder.setTimeUpdateCallback((timeInfo) => {
                    updateCountdown(timeInfo.timeRemaining);
                });

                // å¯åŠ¨æé†’
                waterReminder.start();

                // å¯åŠ¨UIæ›´æ–°å®šæ—¶å™¨
                if (updateTimer) {
                    clearInterval(updateTimer);
                }
                updateTimer = setInterval(() => {
                    if (waterReminder && waterReminder.isActive) {
                        const status = waterReminder.getCurrentStatus();
                        updateCountdown(status.timeRemaining);
                    }
                }, 1000);

                log(`æ°´æé†’å·²å¯åŠ¨ï¼Œå¼€å§‹ç›‘æ§å€’è®¡æ—¶...`);

            } catch (error) {
                log(`å¯åŠ¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`æµ‹è¯•å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                console.error('å¯åŠ¨æµ‹è¯•å¤±è´¥:', error);
            }
        }

        function stopTest() {
            try {
                if (waterReminder) {
                    waterReminder.stop();
                    waterReminder = null;
                }
                
                if (updateTimer) {
                    clearInterval(updateTimer);
                    updateTimer = null;
                }

                updateCountdown(0);
                updateStatus('æµ‹è¯•å·²åœæ­¢', 'info');
                log('æµ‹è¯•å·²åœæ­¢');

            } catch (error) {
                log(`åœæ­¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`åœæ­¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('åœæ­¢æµ‹è¯•å¤±è´¥:', error);
            }
        }

        function analyzeResults(eventType, data = null) {
            const analysisDiv = document.getElementById('analysis-results');
            let analysis = '';

            switch (eventType) {
                case 'correct_initial_countdown':
                    analysis = `
                        <div class="test-result success">
                            <strong>âœ… æµ‹è¯•é€šè¿‡</strong><br>
                            åˆå§‹å€’è®¡æ—¶æ˜¾ç¤ºæ­£ç¡®ï¼Œä»è®¾ç½®çš„ ${expectedInterval} åˆ†é’Ÿå¼€å§‹å€’è®¡æ—¶ã€‚<br>
                            é—®é¢˜å·²ä¿®å¤ï¼
                        </div>
                    `;
                    break;

                case 'incorrect_initial_countdown':
                    analysis = `
                        <div class="test-result error">
                            <strong>âŒ æµ‹è¯•å¤±è´¥</strong><br>
                            åˆå§‹å€’è®¡æ—¶æ˜¾ç¤ºé”™è¯¯ï¼š<br>
                            é¢„æœŸ: ${data.expected}<br>
                            å®é™…: ${data.actual}<br>
                            é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚
                        </div>
                    `;
                    break;

                case 'reminder_triggered':
                    const elapsedTime = Date.now() - testStartTime;
                    const elapsedMinutes = Math.floor(elapsedTime / 60000);
                    const elapsedSeconds = Math.floor((elapsedTime % 60000) / 1000);
                    
                    analysis = `
                        <div class="test-result info">
                            <strong>â° æé†’è§¦å‘</strong><br>
                            ç»è¿‡æ—¶é—´: ${elapsedMinutes}:${elapsedSeconds.toString().padStart(2, '0')}<br>
                            è®¾ç½®é—´éš”: ${expectedInterval}:00<br>
                            ${Math.abs(elapsedMinutes - expectedInterval) <= 1 ? 'âœ… æ—¶é—´å‡†ç¡®' : 'âŒ æ—¶é—´ä¸å‡†ç¡®'}
                        </div>
                    `;
                    break;
            }

            analysisDiv.innerHTML = analysis;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('æœ€ç»ˆä¿®å¤éªŒè¯é¡µé¢å·²åŠ è½½');
            log('è¯·è®¾ç½®é—´éš”æ—¶é—´å¹¶ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®');
            log('é¢„æœŸç»“æœ: å€’è®¡æ—¶åº”è¯¥ä»è®¾ç½®çš„é—´éš”æ—¶é—´å¼€å§‹ï¼Œè€Œä¸æ˜¯ä»30åˆ†é’Ÿå¼€å§‹');
            
            updateStatus('å‡†å¤‡å°±ç»ª - è¯·è®¾ç½®é—´éš”å¹¶å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>