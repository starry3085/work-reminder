<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Fix</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        #log {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æµ‹è¯•æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ</h1>
    
    <div class="test-section">
        <h2>æ­¥éª¤1ï¼šé‡ç½®é¦–æ¬¡ä½¿ç”¨çŠ¶æ€</h2>
        <p>é¦–å…ˆé‡ç½®é¦–æ¬¡ä½¿ç”¨æ ‡è®°ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡æ‰“å¼€åº”ç”¨çš„æƒ…å†µ</p>
        <button class="button" onclick="resetFirstUse()">é‡ç½®ä¸ºé¦–æ¬¡ä½¿ç”¨</button>
        <button class="button success" onclick="markFirstUseComplete()">æ ‡è®°é¦–æ¬¡ä½¿ç”¨å®Œæˆ</button>
    </div>

    <div class="test-section">
        <h2>æ­¥éª¤2ï¼šæµ‹è¯•å¼•å¯¼å¼¹çª—</h2>
        <p>æµ‹è¯•ä¿®å¤åçš„å¼•å¯¼å¼¹çª—æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºå’Œå…³é—­</p>
        <button class="button" onclick="showTestGuide()">æ˜¾ç¤ºæµ‹è¯•å¼•å¯¼å¼¹çª—</button>
        <button class="button danger" onclick="forceCloseGuide()">å¼ºåˆ¶å…³é—­å¼¹çª—</button>
    </div>

    <div class="test-section">
        <h2>æ­¥éª¤3ï¼šæ£€æŸ¥çŠ¶æ€</h2>
        <button class="button" onclick="checkCurrentState()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <button class="button" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="log"></div>
        <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h2>è¿”å›ä¸»åº”ç”¨</h2>
        <a href="index.html" class="button success">è¿”å›ä¸»åº”ç”¨æµ‹è¯•</a>
    </div>

    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script>
        let storageManager, appSettings;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // åˆå§‹åŒ–
        try {
            storageManager = new StorageManager();
            appSettings = new AppSettings(storageManager);
            log('âœ… å­˜å‚¨ç®¡ç†å™¨å’Œè®¾ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
        } catch (error) {
            log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        }

        function resetFirstUse() {
            try {
                log('é‡ç½®é¦–æ¬¡ä½¿ç”¨çŠ¶æ€...', 'info');
                
                // åˆ›å»ºåŒ…å«firstUse: trueçš„è®¾ç½®
                const settings = {
                    water: { enabled: true, interval: 30, sound: true, target: 8 },
                    standup: { enabled: true, interval: 30, sound: true, target: 8, activityDetection: true },
                    notifications: { browserNotifications: true, soundEnabled: true, style: 'standard' },
                    appearance: { theme: 'light', language: 'zh-CN' },
                    firstUse: true  // è®¾ç½®ä¸ºé¦–æ¬¡ä½¿ç”¨
                };
                
                localStorage.setItem('appSettings', JSON.stringify(settings));
                log('âœ… å·²é‡ç½®ä¸ºé¦–æ¬¡ä½¿ç”¨çŠ¶æ€', 'success');
                
            } catch (error) {
                log('âŒ é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function markFirstUseComplete() {
            try {
                log('æ ‡è®°é¦–æ¬¡ä½¿ç”¨å®Œæˆ...', 'info');
                
                if (appSettings) {
                    appSettings.markFirstUseComplete();
                    log('âœ… é¦–æ¬¡ä½¿ç”¨æ ‡è®°å·²å®Œæˆ', 'success');
                } else {
                    // æ‰‹åŠ¨è®¾ç½®
                    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
                    settings.firstUse = false;
                    localStorage.setItem('appSettings', JSON.stringify(settings));
                    log('âœ… æ‰‹åŠ¨æ ‡è®°é¦–æ¬¡ä½¿ç”¨å®Œæˆ', 'success');
                }
                
            } catch (error) {
                log('âŒ æ ‡è®°å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showTestGuide() {
            try {
                log('æ˜¾ç¤ºæµ‹è¯•å¼•å¯¼å¼¹çª—...', 'info');
                
                // åˆ›å»ºå¼•å¯¼å¼¹çª—ï¼ˆä½¿ç”¨ä¿®å¤åçš„ä»£ç ï¼‰
                const guideOverlay = document.createElement('div');
                guideOverlay.className = 'guide-overlay';
                guideOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.6);
                    z-index: 2000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                guideOverlay.innerHTML = `
                    <div class="guide-modal" style="
                        background-color: white;
                        border-radius: 12px;
                        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                        width: 90%;
                        max-width: 500px;
                        max-height: 90vh;
                        overflow-y: auto;
                        padding: 0;
                    ">
                        <div class="guide-header" style="
                            padding: 1rem 1.5rem;
                            border-bottom: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; color: #333;">Welcome to Office Wellness Reminder</h2>
                            <button class="btn-close" id="guide-close" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 30px;
                                height: 30px;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Ã—</button>
                        </div>
                        <div class="guide-content" style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem; color: #666;">è¿™æ˜¯ä¿®å¤åçš„å¼•å¯¼å¼¹çª—æµ‹è¯•ç‰ˆæœ¬ã€‚æ‰€æœ‰æŒ‰é’®éƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
                        </div>
                        <div class="guide-footer" style="
                            padding: 1rem 1.5rem;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                            gap: 1rem;
                        ">
                            <button class="btn-primary" id="guide-settings" style="
                                background: #3498db;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Configure Settings</button>
                            <button class="btn-secondary" id="guide-start" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Start Now</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(guideOverlay);
                log('âœ… å¼•å¯¼å¼¹çª—å·²æ·»åŠ åˆ°DOM', 'success');
                
                // ç»‘å®šäº‹ä»¶
                const closeBtn = document.getElementById('guide-close');
                const settingsBtn = document.getElementById('guide-settings');
                const startBtn = document.getElementById('guide-start');
                
                if (closeBtn) {
                    closeBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('âœ… å…³é—­æŒ‰é’®è¢«ç‚¹å‡»', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('âœ… å…³é—­æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
                }
                
                if (settingsBtn) {
                    settingsBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('âœ… è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('âœ… è®¾ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
                }
                
                if (startBtn) {
                    startBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('âœ… å¼€å§‹æŒ‰é’®è¢«ç‚¹å‡»', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('âœ… å¼€å§‹æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
                }
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                guideOverlay.onclick = (event) => {
                    if (event.target === guideOverlay) {
                        log('âœ… ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    }
                };
                
            } catch (error) {
                log('âŒ æ˜¾ç¤ºå¼•å¯¼å¼¹çª—å¤±è´¥: ' + error.message, 'error');
            }
        }

        function closeGuide(guideOverlay) {
            try {
                log('å…³é—­å¼•å¯¼å¼¹çª—...', 'info');
                if (guideOverlay && guideOverlay.parentNode) {
                    guideOverlay.style.opacity = '0';
                    guideOverlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        if (guideOverlay.parentNode) {
                            guideOverlay.parentNode.removeChild(guideOverlay);
                            log('âœ… å¼•å¯¼å¼¹çª—å·²ä»DOMä¸­ç§»é™¤', 'success');
                        }
                    }, 300);
                } else {
                    log('âš ï¸ å¼•å¯¼å¼¹çª—æœªæ‰¾åˆ°æˆ–å·²è¢«ç§»é™¤', 'info');
                }
            } catch (error) {
                log('âŒ å…³é—­å¼•å¯¼å¼¹çª—å¤±è´¥: ' + error.message, 'error');
            }
        }

        function forceCloseGuide() {
            try {
                log('å¼ºåˆ¶å…³é—­æ‰€æœ‰å¼•å¯¼å¼¹çª—...', 'info');
                const overlays = document.querySelectorAll('.guide-overlay');
                overlays.forEach(overlay => {
                    overlay.remove();
                });
                log(`âœ… å·²å¼ºåˆ¶ç§»é™¤ ${overlays.length} ä¸ªå¼•å¯¼å¼¹çª—`, 'success');
            } catch (error) {
                log('âŒ å¼ºåˆ¶å…³é—­å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkCurrentState() {
            try {
                log('æ£€æŸ¥å½“å‰çŠ¶æ€...', 'info');
                
                const settings = localStorage.getItem('appSettings');
                if (settings) {
                    const parsedSettings = JSON.parse(settings);
                    log(`é¦–æ¬¡ä½¿ç”¨æ ‡è®°: ${parsedSettings.firstUse}`, 'info');
                    log(`æ°´æé†’é—´éš”: ${parsedSettings.water?.interval || 'æœªè®¾ç½®'}åˆ†é’Ÿ`, 'info');
                    log(`ç«™ç«‹æé†’é—´éš”: ${parsedSettings.standup?.interval || 'æœªè®¾ç½®'}åˆ†é’Ÿ`, 'info');
                } else {
                    log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è®¾ç½®', 'info');
                }
                
                const state = localStorage.getItem('appState');
                log(`åº”ç”¨çŠ¶æ€: ${state ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                
                const guideOverlays = document.querySelectorAll('.guide-overlay');
                log(`é¡µé¢ä¸­çš„å¼•å¯¼å¼¹çª—æ•°é‡: ${guideOverlays.length}`, 'info');
                
            } catch (error) {
                log('âŒ æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            try {
                log('æ¸…é™¤æ‰€æœ‰æ•°æ®...', 'info');
                localStorage.clear();
                sessionStorage.clear();
                log('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
            } catch (error) {
                log('âŒ æ¸…é™¤æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            checkCurrentState();
        });
    </script>
</body>
</html>