<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Fix</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        #log {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>🧪 测试最终修复方案</h1>
    
    <div class="test-section">
        <h2>步骤1：重置首次使用状态</h2>
        <p>首先重置首次使用标记，模拟首次打开应用的情况</p>
        <button class="button" onclick="resetFirstUse()">重置为首次使用</button>
        <button class="button success" onclick="markFirstUseComplete()">标记首次使用完成</button>
    </div>

    <div class="test-section">
        <h2>步骤2：测试引导弹窗</h2>
        <p>测试修复后的引导弹窗是否能正常显示和关闭</p>
        <button class="button" onclick="showTestGuide()">显示测试引导弹窗</button>
        <button class="button danger" onclick="forceCloseGuide()">强制关闭弹窗</button>
    </div>

    <div class="test-section">
        <h2>步骤3：检查状态</h2>
        <button class="button" onclick="checkCurrentState()">检查当前状态</button>
        <button class="button" onclick="clearAllData()">清除所有数据</button>
    </div>

    <div class="test-section">
        <h2>测试日志</h2>
        <div id="log"></div>
        <button class="button" onclick="clearLog()">清除日志</button>
    </div>

    <div class="test-section">
        <h2>返回主应用</h2>
        <a href="index.html" class="button success">返回主应用测试</a>
    </div>

    <script src="js/storage-manager.js"></script>
    <script src="js/app-settings.js"></script>
    <script>
        let storageManager, appSettings;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 初始化
        try {
            storageManager = new StorageManager();
            appSettings = new AppSettings(storageManager);
            log('✅ 存储管理器和设置管理器初始化成功', 'success');
        } catch (error) {
            log('❌ 初始化失败: ' + error.message, 'error');
        }

        function resetFirstUse() {
            try {
                log('重置首次使用状态...', 'info');
                
                // 创建包含firstUse: true的设置
                const settings = {
                    water: { enabled: true, interval: 30, sound: true, target: 8 },
                    standup: { enabled: true, interval: 30, sound: true, target: 8, activityDetection: true },
                    notifications: { browserNotifications: true, soundEnabled: true, style: 'standard' },
                    appearance: { theme: 'light', language: 'zh-CN' },
                    firstUse: true  // 设置为首次使用
                };
                
                localStorage.setItem('appSettings', JSON.stringify(settings));
                log('✅ 已重置为首次使用状态', 'success');
                
            } catch (error) {
                log('❌ 重置失败: ' + error.message, 'error');
            }
        }

        function markFirstUseComplete() {
            try {
                log('标记首次使用完成...', 'info');
                
                if (appSettings) {
                    appSettings.markFirstUseComplete();
                    log('✅ 首次使用标记已完成', 'success');
                } else {
                    // 手动设置
                    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
                    settings.firstUse = false;
                    localStorage.setItem('appSettings', JSON.stringify(settings));
                    log('✅ 手动标记首次使用完成', 'success');
                }
                
            } catch (error) {
                log('❌ 标记失败: ' + error.message, 'error');
            }
        }

        function showTestGuide() {
            try {
                log('显示测试引导弹窗...', 'info');
                
                // 创建引导弹窗（使用修复后的代码）
                const guideOverlay = document.createElement('div');
                guideOverlay.className = 'guide-overlay';
                guideOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.6);
                    z-index: 2000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                guideOverlay.innerHTML = `
                    <div class="guide-modal" style="
                        background-color: white;
                        border-radius: 12px;
                        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                        width: 90%;
                        max-width: 500px;
                        max-height: 90vh;
                        overflow-y: auto;
                        padding: 0;
                    ">
                        <div class="guide-header" style="
                            padding: 1rem 1.5rem;
                            border-bottom: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; color: #333;">Welcome to Office Wellness Reminder</h2>
                            <button class="btn-close" id="guide-close" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 30px;
                                height: 30px;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">×</button>
                        </div>
                        <div class="guide-content" style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem; color: #666;">这是修复后的引导弹窗测试版本。所有按钮都应该能正常工作。</p>
                        </div>
                        <div class="guide-footer" style="
                            padding: 1rem 1.5rem;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                            gap: 1rem;
                        ">
                            <button class="btn-primary" id="guide-settings" style="
                                background: #3498db;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Configure Settings</button>
                            <button class="btn-secondary" id="guide-start" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Start Now</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(guideOverlay);
                log('✅ 引导弹窗已添加到DOM', 'success');
                
                // 绑定事件
                const closeBtn = document.getElementById('guide-close');
                const settingsBtn = document.getElementById('guide-settings');
                const startBtn = document.getElementById('guide-start');
                
                if (closeBtn) {
                    closeBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('✅ 关闭按钮被点击', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('✅ 关闭按钮事件已绑定', 'success');
                }
                
                if (settingsBtn) {
                    settingsBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('✅ 设置按钮被点击', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('✅ 设置按钮事件已绑定', 'success');
                }
                
                if (startBtn) {
                    startBtn.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        log('✅ 开始按钮被点击', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    };
                    log('✅ 开始按钮事件已绑定', 'success');
                }
                
                // 点击外部关闭
                guideOverlay.onclick = (event) => {
                    if (event.target === guideOverlay) {
                        log('✅ 点击外部区域关闭', 'success');
                        closeGuide(guideOverlay);
                        markFirstUseComplete();
                    }
                };
                
            } catch (error) {
                log('❌ 显示引导弹窗失败: ' + error.message, 'error');
            }
        }

        function closeGuide(guideOverlay) {
            try {
                log('关闭引导弹窗...', 'info');
                if (guideOverlay && guideOverlay.parentNode) {
                    guideOverlay.style.opacity = '0';
                    guideOverlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        if (guideOverlay.parentNode) {
                            guideOverlay.parentNode.removeChild(guideOverlay);
                            log('✅ 引导弹窗已从DOM中移除', 'success');
                        }
                    }, 300);
                } else {
                    log('⚠️ 引导弹窗未找到或已被移除', 'info');
                }
            } catch (error) {
                log('❌ 关闭引导弹窗失败: ' + error.message, 'error');
            }
        }

        function forceCloseGuide() {
            try {
                log('强制关闭所有引导弹窗...', 'info');
                const overlays = document.querySelectorAll('.guide-overlay');
                overlays.forEach(overlay => {
                    overlay.remove();
                });
                log(`✅ 已强制移除 ${overlays.length} 个引导弹窗`, 'success');
            } catch (error) {
                log('❌ 强制关闭失败: ' + error.message, 'error');
            }
        }

        function checkCurrentState() {
            try {
                log('检查当前状态...', 'info');
                
                const settings = localStorage.getItem('appSettings');
                if (settings) {
                    const parsedSettings = JSON.parse(settings);
                    log(`首次使用标记: ${parsedSettings.firstUse}`, 'info');
                    log(`水提醒间隔: ${parsedSettings.water?.interval || '未设置'}分钟`, 'info');
                    log(`站立提醒间隔: ${parsedSettings.standup?.interval || '未设置'}分钟`, 'info');
                } else {
                    log('⚠️ 没有找到保存的设置', 'info');
                }
                
                const state = localStorage.getItem('appState');
                log(`应用状态: ${state ? '存在' : '不存在'}`, 'info');
                
                const guideOverlays = document.querySelectorAll('.guide-overlay');
                log(`页面中的引导弹窗数量: ${guideOverlays.length}`, 'info');
                
            } catch (error) {
                log('❌ 检查状态失败: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            try {
                log('清除所有数据...', 'info');
                localStorage.clear();
                sessionStorage.clear();
                log('✅ 所有数据已清除', 'success');
            } catch (error) {
                log('❌ 清除数据失败: ' + error.message, 'error');
            }
        }

        // 页面加载时检查状态
        window.addEventListener('load', () => {
            log('🚀 测试页面已加载', 'success');
            checkCurrentState();
        });
    </script>
</body>
</html>