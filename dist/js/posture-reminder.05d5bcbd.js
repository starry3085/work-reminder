class PostureReminder extends ReminderManager{constructor(t,i,s){super("posture",t,i,s),this.dailyActivityCount=0,this.dailyGoal=8,this.lastActivityTime=null,this.activityHistory=[],this.totalSittingTime=0,this.currentSittingStart=null,this.isUserAway=!1,this.awayStartTime=null,this.lastUserActivity=Date.now(),this.activityThreshold=60*(t.activityThreshold||5)*1e3,this.loadDailyData(),this.setupEnhancedActivityDetection(),console.log("ä¹…åæé†’å™¨å·²åˆ›å»º")}loadDailyData(){try{const t=(new Date).toDateString(),i=localStorage.getItem("postureReminder_dailyData");if(i){const s=JSON.parse(i);s.date===t?(this.dailyActivityCount=s.count||0,this.activityHistory=s.history||[],this.lastActivityTime=s.lastActivityTime||null,this.totalSittingTime=s.totalSittingTime||0):this.resetDailyData()}}catch(t){console.warn("åŠ è½½ä»Šæ—¥ä¹…åæ•°æ®å¤±è´¥:",t),this.resetDailyData()}}saveDailyData(){try{const t={date:(new Date).toDateString(),count:this.dailyActivityCount,history:this.activityHistory,lastActivityTime:this.lastActivityTime,totalSittingTime:this.totalSittingTime};localStorage.setItem("postureReminder_dailyData",JSON.stringify(t))}catch(t){console.warn("ä¿å­˜ä»Šæ—¥ä¹…åæ•°æ®å¤±è´¥:",t)}}resetDailyData(){this.dailyActivityCount=0,this.activityHistory=[],this.lastActivityTime=null,this.totalSittingTime=0,this.currentSittingStart=Date.now(),this.saveDailyData()}setupEnhancedActivityDetection(){if(!this.activityDetector)return;const t=this.activityDetector.callback;this.activityDetector.callback=i=>{t&&t(i),this.handleEnhancedActivityEvent(i)},this.startContinuousMonitoring()}handleEnhancedActivityEvent(t){const i=Date.now();switch(this.lastUserActivity=i,t.type){case"user-activity":this.isUserAway&&this.handleUserReturn(),this.isActive&&!this.isPaused&&this.handleActivityDuringReminder();break;case"user-away":this.handleUserAway();break;case"user-return":this.handleUserReturn()}}handleUserAway(){this.isUserAway||(this.isUserAway=!0,this.awayStartTime=Date.now(),this.currentSittingStart&&(this.totalSittingTime+=this.awayStartTime-this.currentSittingStart,this.currentSittingStart=null),this.isActive&&!this.isPaused&&this.pause(!0),console.log("ç”¨æˆ·ç¦»å¼€ï¼Œä¹…åæé†’å·²è‡ªåŠ¨æš‚åœ"))}handleUserReturn(){if(!this.isUserAway)return;const t=Date.now(),i=t-this.awayStartTime;this.isUserAway=!1,this.currentSittingStart=t,i>this.activityThreshold&&this.recordActivity("away-break",i),this.isActive&&this.isPaused&&this.resume(!0),console.log(`ç”¨æˆ·è¿”å›ï¼Œç¦»å¼€æ—¶é•¿: ${Math.round(i/6e4)}åˆ†é’Ÿ`)}handleActivityDuringReminder(){const t=Date.now();if(t-this.lastUserActivity<3e4){const i=3e5;this.timeRemaining=Math.min(this.timeRemaining+i,60*this.settings.interval*1e3),this.nextReminderTime=t+this.timeRemaining,this.clearTimer(),this.startTimer(),console.log("æ£€æµ‹åˆ°ç”¨æˆ·æ´»åŠ¨ï¼Œä¹…åæé†’å·²å»¶é•¿5åˆ†é’Ÿ")}}startContinuousMonitoring(){this.monitoringInterval=setInterval(()=>{this.checkUserStatus()},6e4)}checkUserStatus(){Date.now()-this.lastUserActivity>this.activityThreshold&&!this.isUserAway&&this.handleUserAway(),this.currentSittingStart&&!this.isUserAway&&(this.totalSittingTime+=6e4)}confirmActivity(t=5,i="manual"){const s=Date.now();this.recordActivity(i,60*t*1e3),this.settings.lastReminder=s,this.reset(),this.showActivityConfirmation(t,i),this.triggerStatusChange({status:"activity-confirmed",isActive:!0,isPaused:!1,timeRemaining:this.timeRemaining,dailyCount:this.dailyActivityCount,dailyGoal:this.dailyGoal,lastActivityTime:this.lastActivityTime}),console.log(`å·²ç¡®è®¤èµ·èº«æ´»åŠ¨ï¼Œä»Šæ—¥ç¬¬${this.dailyActivityCount}æ¬¡`)}recordActivity(t,i){const s=Date.now();this.dailyActivityCount++,this.lastActivityTime=s,this.activityHistory.push({time:s,type:t,duration:i}),this.currentSittingStart=s,this.saveDailyData()}showActivityConfirmation(t,i){const s=Math.min(this.dailyActivityCount/this.dailyGoal,1),e=Math.round(100*s);let a=`å¾ˆå¥½ï¼ä»Šæ—¥å·²æ´»åŠ¨ ${this.dailyActivityCount} æ¬¡`;this.dailyActivityCount>=this.dailyGoal?a+="\nğŸ‰ æ­å–œï¼æ‚¨å·²å®Œæˆä»Šæ—¥æ´»åŠ¨ç›®æ ‡ï¼":a+=`\nè¿˜éœ€ ${this.dailyGoal-this.dailyActivityCount} æ¬¡å³å¯å®Œæˆä»Šæ—¥ç›®æ ‡ (${e}%)`,"away-break"===i&&(a+=`\næ£€æµ‹åˆ°æ‚¨ç¦»å¼€äº† ${Math.round(t/6e4)} åˆ†é’Ÿï¼Œå¾ˆå¥½çš„ä¼‘æ¯ï¼`),this.notificationService.showInPageAlert("success",{title:"ğŸ§˜ æ´»åŠ¨ç¡®è®¤",message:a,duration:3e3}),this.dailyActivityCount===this.dailyGoal&&setTimeout(()=>{this.notificationService.showInPageAlert("celebration",{title:"ğŸ‰ ç›®æ ‡è¾¾æˆï¼",message:"æ­å–œæ‚¨å®Œæˆä»Šæ—¥æ´»åŠ¨ç›®æ ‡ï¼ç»§ç»­ä¿æŒå¥åº·çš„å·¥ä½œä¹ æƒ¯ï¼",duration:5e3})},1e3)}triggerReminder(){if(!this.isActive)return;let t="ä¹…åå¯¹èº«ä½“ä¸å¥½ï¼Œèµ·æ¥æ´»åŠ¨ä¸€ä¸‹å§ï¼";const i=Math.round(this.totalSittingTime/36e5*10)/10;if(this.dailyActivityCount>0){const i=Math.max(0,this.dailyGoal-this.dailyActivityCount);i>0?t+=`\nä»Šæ—¥å·²æ´»åŠ¨ ${this.dailyActivityCount} æ¬¡ï¼Œè¿˜éœ€ ${i} æ¬¡å®Œæˆç›®æ ‡`:t="ç»§ç»­ä¿æŒè‰¯å¥½çš„æ´»åŠ¨ä¹ æƒ¯ï¼"}i>0&&(t+=`\nä»Šæ—¥å·²åç€ ${i} å°æ—¶`),this.notificationService.showNotification("posture","ğŸ§˜ è¯¥èµ·èº«æ´»åŠ¨äº†ï¼",t,()=>this.confirmActivity(),()=>this.snooze(),{actions:[{action:"activity",title:"å·²èµ·èº«æ´»åŠ¨",icon:"ğŸ§˜"},{action:"snooze",title:"5åˆ†é’Ÿåæé†’",icon:"â°"}]}),this.triggerStatusChange({status:"triggered",isActive:!0,isPaused:!1,timeRemaining:0,dailyCount:this.dailyActivityCount,dailyGoal:this.dailyGoal}),setTimeout(()=>{this.isActive&&0===this.timeRemaining&&this.reset()},6e4),console.log("ä¹…åæé†’å·²è§¦å‘")}getDailyStats(){const t=this.activityHistory.reduce((t,i)=>t+i.duration,0),i=Math.min(this.dailyActivityCount/this.dailyGoal,1),s=Math.round(this.totalSittingTime/36e5*10)/10;return{count:this.dailyActivityCount,goal:this.dailyGoal,progress:i,progressPercent:Math.round(100*i),totalActivityTime:t,totalSittingTime:this.totalSittingTime,sittingHours:s,lastActivityTime:this.lastActivityTime,history:[...this.activityHistory],isGoalReached:this.dailyActivityCount>=this.dailyGoal,averageActivityDuration:this.activityHistory.length>0?Math.round(t/this.activityHistory.length/6e4):0}}setDailyGoal(t){t>0&&t<=20?(this.dailyGoal=t,this.saveDailyData(),console.log(`æ¯æ—¥æ´»åŠ¨ç›®æ ‡å·²è®¾ç½®ä¸º ${t} æ¬¡`)):console.warn("æ¯æ—¥ç›®æ ‡åº”åœ¨1-20æ¬¡ä¹‹é—´")}setActivityThreshold(t){t>0&&t<=30?(this.activityThreshold=60*t*1e3,this.settings.activityThreshold=t,console.log(`æ´»åŠ¨é˜ˆå€¼å·²è®¾ç½®ä¸º ${t} åˆ†é’Ÿ`)):console.warn("æ´»åŠ¨é˜ˆå€¼åº”åœ¨1-30åˆ†é’Ÿä¹‹é—´")}getHealthSuggestion(){const t=this.getDailyStats(),i=(new Date).getHours();return t.sittingHours>6?"ä»Šæ—¥åç€æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®å¢åŠ æ´»åŠ¨é¢‘ç‡ï¼Œæ¯30åˆ†é’Ÿèµ·èº«ä¸€æ¬¡":t.count<.5*t.goal&&i>14?"ä¸‹åˆäº†ï¼Œæ´»åŠ¨æ¬¡æ•°è¿˜ä¸å¤Ÿï¼Œè®°å¾—å¤šèµ·èº«èµ°åŠ¨":t.count>=t.goal?"ä»Šæ—¥æ´»åŠ¨ç›®æ ‡å·²è¾¾æˆï¼ç»§ç»­ä¿æŒè‰¯å¥½ä¹ æƒ¯":i<12?"ä¸Šåˆå·¥ä½œæ—¶é—´ï¼Œè®°å¾—æ¯å°æ—¶èµ·èº«æ´»åŠ¨ä¸€ä¸‹":i<18?"ä¸‹åˆå®¹æ˜“ç–²åŠ³ï¼Œé€‚å½“æ´»åŠ¨æœ‰åŠ©äºæé«˜å·¥ä½œæ•ˆç‡":"å·¥ä½œæ—¥å³å°†ç»“æŸï¼Œåšäº›è½»æ¾çš„ä¼¸å±•è¿åŠ¨å§"}getCurrentStatus(){return{...super.getCurrentStatus(),dailyStats:this.getDailyStats(),suggestion:this.getHealthSuggestion(),isUserAway:this.isUserAway,lastUserActivity:this.lastUserActivity,activityThreshold:this.activityThreshold}}start(){this.currentSittingStart||(this.currentSittingStart=Date.now()),super.start()}stop(){this.currentSittingStart&&(this.totalSittingTime+=Date.now()-this.currentSittingStart,this.currentSittingStart=null,this.saveDailyData()),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),super.stop()}reset(){super.reset();const t=(new Date).toDateString(),i=localStorage.getItem("postureReminder_dailyData");if(i)try{JSON.parse(i).date!==t&&this.resetDailyData()}catch(t){console.warn("æ£€æŸ¥æ—¥æœŸæ•°æ®å¤±è´¥:",t)}}destroy(){this.currentSittingStart&&(this.totalSittingTime+=Date.now()-this.currentSittingStart),this.saveDailyData(),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),super.destroy(),console.log("ä¹…åæé†’å™¨å·²é”€æ¯")}}"undefined"!=typeof module&&module.exports&&(module.exports=PostureReminder);