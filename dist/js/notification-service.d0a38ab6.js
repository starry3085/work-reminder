class NotificationService{constructor(){this.hasPermission=!1,this.isSupported="Notification"in window,this.soundEnabled=!0,this.audioContext=null,this.audioFiles={water:null,posture:null,default:null},this.isSupported&&"granted"===Notification.permission&&(this.hasPermission=!0),this.initAudioContext()}initAudioContext(){try{if(window.AudioContext||window.webkitAudioContext){const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,console.log("éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–æˆåŠŸ")}else console.warn("æµè§ˆå™¨ä¸æ”¯æŒWeb Audio APIï¼Œå°†ä½¿ç”¨HTML5 Audio")}catch(t){console.warn("åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:",t),this.audioContext=null}}async requestPermission(){if(!this.isSupported)return console.warn("æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½"),!1;try{const t=await Notification.requestPermission();return this.hasPermission="granted"===t,this.hasPermission?console.log("é€šçŸ¥æƒé™å·²è·å¾—"):console.warn("ç”¨æˆ·æ‹’ç»äº†é€šçŸ¥æƒé™"),this.hasPermission}catch(t){return console.error("è¯·æ±‚é€šçŸ¥æƒé™æ—¶å‡ºé”™:",t),!1}}showNotification(t,i,e,n,o){return this.showBrowserNotification(t,i,e)||this.showInPageAlert(t,i,e,n,o),this.soundEnabled&&this.playSound(t),!0}showBrowserNotification(t,i,e){if(!this.isSupported)return console.warn("æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½ï¼Œä½¿ç”¨é¡µé¢å†…é€šçŸ¥"),!1;if(!this.hasPermission)return console.warn("æ²¡æœ‰é€šçŸ¥æƒé™ï¼Œä½¿ç”¨é¡µé¢å†…é€šçŸ¥"),!1;try{const n={body:e,icon:this.getNotificationIcon(t),badge:this.getNotificationIcon(t),tag:`wellness-reminder-${t}`,requireInteraction:!0,silent:!this.soundEnabled,vibrate:[200,100,200]},o=new Notification(i,n);return o.onclick=()=>{window.focus(),o.close(),window.app&&window.app[`${t}Reminder`]&&window.app[`${t}Reminder`].acknowledge()},setTimeout(()=>{o.close()},3e4),!0}catch(t){return console.error("æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥æ—¶å‡ºé”™:",t),!1}}showInPageAlert(t,i,e,n,o){this.hideInPageAlert();const s=window.mobileAdapter&&window.mobileAdapter.isMobile,a=document.createElement("div");a.className=`notification-alert notification-${t}${s?" mobile":""}`,a.id="wellness-notification",a.innerHTML=s?`\n                <div class="notification-content">\n                    <div class="notification-icon">\n                        ${this.getNotificationEmoji(t)}\n                    </div>\n                    <div class="notification-text">\n                        <h3 class="notification-title">${i}</h3>\n                        <p class="notification-message">${e}</p>\n                    </div>\n                </div>\n                <div class="notification-actions">\n                    <button class="btn btn-primary mobile-touch-feedback" id="confirm-btn">\n                        ${"water"===t?"å·²å–æ°´":"å·²èµ·èº«æ´»åŠ¨"}\n                    </button>\n                    <button class="btn btn-secondary mobile-touch-feedback" id="snooze-btn">\n                        ç¨åæé†’\n                    </button>\n                </div>\n            `:`\n                <div class="notification-content">\n                    <div class="notification-icon">\n                        ${this.getNotificationEmoji(t)}\n                    </div>\n                    <div class="notification-text">\n                        <h3 class="notification-title">${i}</h3>\n                        <p class="notification-message">${e}</p>\n                    </div>\n                    <button class="btn btn-close" id="close-btn">Ã—</button>\n                </div>\n                <div class="notification-actions">\n                    <button class="btn btn-primary" id="confirm-btn">\n                        ${"water"===t?"å·²å–æ°´":"å·²èµ·èº«æ´»åŠ¨"}\n                    </button>\n                    <button class="btn btn-secondary" id="snooze-btn">\n                        ç¨åæé†’\n                    </button>\n                </div>\n            `,document.body.appendChild(a);const r=a.querySelector("#confirm-btn"),c=a.querySelector("#snooze-btn"),d=a.querySelector("#close-btn");if(r.addEventListener("click",()=>{this.hideInPageAlert(),n&&n()}),c.addEventListener("click",()=>{this.hideInPageAlert(),o&&o()}),d&&d.addEventListener("click",()=>{this.hideInPageAlert()}),s&&a.addEventListener("click",t=>{t.target===a&&this.hideInPageAlert()}),setTimeout(()=>{a.classList.add("show")},100),setTimeout(()=>{document.getElementById("wellness-notification")&&this.hideInPageAlert()},s?3e4:6e4),s&&navigator.vibrate)try{navigator.vibrate([200,100,200])}catch(t){console.warn("æŒ¯åŠ¨APIä¸å¯ç”¨:",t)}}playSound(t){if(this.soundEnabled)try{this.audioContext?this.playBeepSound(t):this.playAudioFile(t)}catch(t){console.warn("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:",t)}}isNotificationSupported(){return this.isSupported}setSoundEnabled(t){this.soundEnabled=t}getNotificationIcon(t){return"water"===t?"assets/water-icon.png":"posture"===t?"assets/posture-icon.png":"assets/default-icon.png"}getNotificationEmoji(t){return"water"===t?"ğŸ’§":"posture"===t?"ğŸ§˜":"â°"}hideInPageAlert(){const t=document.getElementById("wellness-notification");t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}playBeepSound(t){try{if(!this.audioContext&&(this.initAudioContext(),!this.audioContext))throw new Error("éŸ³é¢‘ä¸Šä¸‹æ–‡ä¸å¯ç”¨");"suspended"===this.audioContext.state&&this.audioContext.resume();const i=this.audioContext.createOscillator(),e=this.audioContext.createGain();i.connect(e),e.connect(this.audioContext.destination),"water"===t?(i.type="sine",i.frequency.value=800,e.gain.value=.1,i.start(),e.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),setTimeout(()=>{i.stop()},300)):"posture"===t?(i.type="triangle",i.frequency.value=600,e.gain.value=.1,i.start(),setTimeout(()=>{i.frequency.value=700},200),setTimeout(()=>{i.stop()},400)):(i.type="sine",i.frequency.value=700,e.gain.value=.1,i.start(),setTimeout(()=>{i.stop()},200))}catch(i){console.warn("Web Audio APIä¸å¯ç”¨:",i),this.playAudioFile(t)}}playAudioFile(t){try{if(!this.audioFiles[t]){const i=new Audio;i.volume=.5,i.src="water"===t?"assets/water-reminder.mp3":"posture"===t?"assets/posture-reminder.mp3":"assets/notification.mp3",this.audioFiles[t]=i}const i=this.audioFiles[t];i.currentTime=0,i.play().catch(i=>{if(console.warn("æ’­æ”¾éŸ³é¢‘å¤±è´¥:",i),"NotAllowedError"===i.name){const i=new Audio;i.volume=.5,i.src="water"===t?"assets/water-reminder.mp3":"posture"===t?"assets/posture-reminder.mp3":"assets/notification.mp3",i.play().catch(t=>{console.warn("äºŒæ¬¡å°è¯•æ’­æ”¾éŸ³é¢‘å¤±è´¥:",t)})}})}catch(t){console.warn("HTML5 Audioä¸å¯ç”¨:",t)}}checkPermissionStatus(){return this.isSupported?Notification.permission:"unsupported"}showPermissionPrompt(t){const i=document.createElement("div");i.className="permission-prompt",i.id="notification-permission-prompt",i.innerHTML='\n            <div class="prompt-content">\n                <div class="prompt-icon">ğŸ””</div>\n                <div class="prompt-text">\n                    <h3>å¯ç”¨é€šçŸ¥</h3>\n                    <p>ä¸ºäº†æ›´å¥½åœ°æé†’æ‚¨å–æ°´å’Œèµ·èº«æ´»åŠ¨ï¼Œè¯·å…è®¸æµè§ˆå™¨é€šçŸ¥æƒé™ã€‚</p>\n                </div>\n                <div class="prompt-actions">\n                    <button class="btn btn-primary" id="request-permission-btn">å…è®¸é€šçŸ¥</button>\n                    <button class="btn btn-secondary" id="dismiss-prompt-btn">ç¨åå†è¯´</button>\n                </div>\n            </div>\n        ',document.body.appendChild(i);const e=i.querySelector("#request-permission-btn"),n=i.querySelector("#dismiss-prompt-btn");e.addEventListener("click",()=>{this.hidePermissionPrompt(),t&&t()}),n.addEventListener("click",()=>{this.hidePermissionPrompt()}),setTimeout(()=>{i.classList.add("show")},100)}hidePermissionPrompt(){const t=document.getElementById("notification-permission-prompt");t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}}